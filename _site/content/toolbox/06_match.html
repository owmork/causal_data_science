<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-10-01">

<title>Causal Data Science for Business Analytics - Matching and Subclassification</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../content/toolbox/07_did.html" rel="next">
<link href="../../content/toolbox/05_rct.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Causal Data Science for Business Analytics</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../content/index.html" aria-current="page">Content</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Matching and Subclassification</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/index.html" class="sidebar-item-text sidebar-link">Overview</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Fundamentals</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/01_prob.html" class="sidebar-item-text sidebar-link">Probability Theory and Statistics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/02_reg.html" class="sidebar-item-text sidebar-link">Regression and Statistical Inference</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/03_caus.html" class="sidebar-item-text sidebar-link">Causal Inference</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/fundamentals/04_dag.html" class="sidebar-item-text sidebar-link">Directed Acyclic Graphs</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Toolbox</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/05_rct.html" class="sidebar-item-text sidebar-link">Randomized Controlled Trials</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/06_match.html" class="sidebar-item-text sidebar-link active">Matching and Subclassification</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/07_did.html" class="sidebar-item-text sidebar-link">Difference-in-Differences</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/08_iv.html" class="sidebar-item-text sidebar-link">Instrumental Variables</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/toolbox/09_rdd.html" class="sidebar-item-text sidebar-link">Regression Discontinuity</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#problem" id="toc-problem" class="nav-link active" data-scroll-target="#problem">Problem</a></li>
  <li><a href="#intuition" id="toc-intuition" class="nav-link" data-scroll-target="#intuition">Intuition</a></li>
  <li><a href="#subclassification-estimator" id="toc-subclassification-estimator" class="nav-link" data-scroll-target="#subclassification-estimator">Subclassification Estimator</a></li>
  <li><a href="#matching-as-a-concept" id="toc-matching-as-a-concept" class="nav-link" data-scroll-target="#matching-as-a-concept">Matching as a Concept</a>
  <ul class="collapse">
  <li><a href="#single-matching-variable" id="toc-single-matching-variable" class="nav-link" data-scroll-target="#single-matching-variable">Single Matching Variable</a>
  <ul class="collapse">
  <li><a href="#coarsened-exact-matching" id="toc-coarsened-exact-matching" class="nav-link" data-scroll-target="#coarsened-exact-matching">(Coarsened) Exact Matching</a></li>
  <li><a href="#matched-weighted-sample" id="toc-matched-weighted-sample" class="nav-link" data-scroll-target="#matched-weighted-sample">Matched weighted sample</a></li>
  </ul></li>
  <li><a href="#application-multiple-matching-variables" id="toc-application-multiple-matching-variables" class="nav-link" data-scroll-target="#application-multiple-matching-variables">Application: Multiple Matching Variables</a>
  <ul class="collapse">
  <li><a href="#coarsened-exact-matching-1" id="toc-coarsened-exact-matching-1" class="nav-link" data-scroll-target="#coarsened-exact-matching-1">(Coarsened) Exact Matching</a></li>
  <li><a href="#nearest-neighbor-matching" id="toc-nearest-neighbor-matching" class="nav-link" data-scroll-target="#nearest-neighbor-matching">Nearest-Neighbor matching</a></li>
  <li><a href="#curse-of-dimensionality" id="toc-curse-of-dimensionality" class="nav-link" data-scroll-target="#curse-of-dimensionality">Curse of dimensionality</a></li>
  <li><a href="#inverse-probability-weighting" id="toc-inverse-probability-weighting" class="nav-link" data-scroll-target="#inverse-probability-weighting">Inverse Probability weighting</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions">Assumptions</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#assignment" id="toc-assignment" class="nav-link" data-scroll-target="#assignment">Assignment</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Matching and Subclassification</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 1, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdag)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dagitty)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="problem" class="level1">
<h1>Problem</h1>
<p>Almost always, the problem we are trying to solve in causal inference relates to the fundamental problem of causal inference, the fact that we cannot observe two states for one particular observation unit, e.g.&nbsp;we cannot see how a person’s health status changes after taking a specific drug and after not taking the same drug. Consequently, we cannot know the individual treatment effect.</p>
<p>Thus, we said we can make use of averages and try to estimate the average treatment effect by taking the difference between a group of treated observation units and a group of untreated observation units. Written in a formula, we can present it as</p>
<p><span class="math display">\[
ATE = E[Y(1)| D = 1] - E[Y(0) | D = 0]
\]</span></p>
<p>Assuming that individuals (or other kinds of observation units) were randomly assigned for example to take the drug, then this result gives us exactly what we want. It compares the outcomes of groups under treatment with groups not under treatment.</p>
<p>But the estimate hinges on the assumption that both groups are comparable, formally <span class="math inline">\(E[Y(0)|D=0] = E[Y(1)|D=0]\)</span>, which we cannot test but in a randomized setting we have good reason to believe it to be true. Under these circumstances, average treatment effect (<span class="math inline">\(ATE\)</span>) and the average treatment effect on the treated (<span class="math inline">\(ATT\)</span>) are equal.</p>
<p>However, if there are in fact underlying group differences because the treatment assignment was not randomized and e.g.&nbsp;individuals were able to choose their treatment, we are not measuring the estimate that we are interested in. Then, the difference between <span class="math inline">\(ATE\)</span> and <span class="math inline">\(ATT\)</span> is what we call <em>selection bias</em>, an unmeasured factor representing systematic bias:</p>
<p><span class="math display">\[
ATE = ATT + \text{selection bias}
\]</span></p>
<p>Graphically, we can show an example of when the naive estimate would fail.</p>
<p>By now, you might recognize what kind of problem the DAG depicts: confounding. A variable <span class="math inline">\(Z\)</span> confounds the relationship between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> and to estimate the causal effect of <span class="math inline">\(X\)</span> on <span class="math inline">\(Y\)</span>, we need to close the backdoor path of <span class="math inline">\(X\)</span> to <span class="math inline">\(Y\)</span> via <span class="math inline">\(Z\)</span>.</p>
</section>
<section id="intuition" class="level1">
<h1>Intuition</h1>
<p>One of the options to close it is <strong>matching</strong>, which covers any method attempting to equate or balance the distribution of covariates in treatment and control group. Simply put, the goal of matching is to compare apple to apples and post treatment make treatment and control group as similar as possible (of course, except for the treatment value).</p>
<p>In a way, matching is an alternative to using regression to close backdoors and neither is better or worse, in fact, they can even be combined. But for now, let us focus on matching and understand what it really it is, what kind of matching methods are popular and how they can be applied in <code>R</code>.</p>
<p>Let us assume you would like to study a phenomena and only have observational data that looks like this. <span class="math inline">\(Z\)</span> is a covariate, <span class="math inline">\(Y\)</span> is the outcome and the color of the data points shows if a unit has been treated or not. From the first glance you can already see that the data does not look as if you would expect in a randomized experiment. For values of <span class="math inline">\(Z\)</span> in the middle range, there are both treated and untreated cases, but for values at the lower and upper range there are only untreated cases. That is an indication that <span class="math inline">\(Z\)</span> confounds the relationship between <span class="math inline">\(D\)</span> and <span class="math inline">\(Y\)</span>.</p>
<p>!!! Change text to application (education) or own example</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Observations both treated and control (mid education)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>matched_stuff <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">education =</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="dv">20</span>, <span class="dv">3</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">outcome =</span> <span class="dv">15</span> <span class="sc">+</span> education <span class="sc">*</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="sc">-</span><span class="fl">0.2</span>, <span class="fl">0.05</span>), </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">treatment =</span> <span class="fu">as.logical</span>(<span class="fu">rbinom</span>(<span class="fu">n</span>(), <span class="dv">1</span>, <span class="fl">0.5</span>)),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">type =</span> <span class="st">"Matched"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Observations control (low education)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>unmatched_stuff_low <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">education =</span> <span class="fu">rnorm</span>(<span class="dv">20</span>, <span class="dv">12</span>, <span class="dv">2</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">outcome =</span> <span class="fu">rnorm</span>(<span class="dv">20</span>, <span class="dv">5</span>, <span class="dv">2</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">treatment =</span> <span class="cn">FALSE</span>, </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">type =</span> <span class="st">"Unmatched"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Observations control (high education)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>unmatched_stuff_high <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">education =</span> <span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="dv">28</span>, <span class="dv">1</span>),</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">outcome =</span> <span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="dv">5</span>, <span class="fl">0.5</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                               <span class="at">treatment =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="st">"Unmatched"</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># All observations</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(matched_stuff, </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                      unmatched_stuff_low,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                      unmatched_stuff_high) <span class="sc">%&gt;%</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">treatment =</span> <span class="fu">factor</span>(treatment, </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                            <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Untreated"</span>, <span class="st">"Treated"</span>)))</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Part of data that has matches (with factor treatment)</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>matched_stuff_real <span class="ot">&lt;-</span> <span class="fu">filter</span>(all_data, type <span class="sc">==</span> <span class="st">"Matched"</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrong model</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>model_wrong <span class="ot">&lt;-</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(outcome <span class="sc">~</span> education <span class="sc">+</span> treatment, <span class="at">data =</span> all_data) <span class="sc">%&gt;%</span> </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>()</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrong model with square term</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>model_wrong1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(outcome <span class="sc">~</span> education <span class="sc">+</span> treatment <span class="sc">+</span> <span class="fu">I</span>(education<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> all_data)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>model_wrong1_fitted <span class="ot">&lt;-</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">education =</span> <span class="fu">seq</span>(<span class="dv">8</span>, <span class="dv">30</span>, <span class="fl">0.1</span>),</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>              <span class="at">treatment =</span> <span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="st">"Untreated"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">augment</span>(model_wrong1, <span class="at">newdata =</span> .)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Better model</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>model_better <span class="ot">&lt;-</span> <span class="fu">lm</span>(outcome <span class="sc">~</span> education <span class="sc">+</span> treatment, <span class="at">data =</span> matched_stuff_real) <span class="sc">%&gt;%</span> </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">tidy</span>()</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Better model with square term</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>model_better1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(outcome <span class="sc">~</span> education <span class="sc">+</span> treatment <span class="sc">+</span> <span class="fu">I</span>(education<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> matched_stuff_real)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>model_better1_fitted <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">education =</span> <span class="fu">seq</span>(<span class="dv">8</span>, <span class="dv">30</span>, <span class="fl">0.1</span>),</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">treatment =</span> <span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="st">"Untreated"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  broom<span class="sc">::</span><span class="fu">augment</span>(model_better1, <span class="at">newdata =</span> .)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>When we plot a line through all blue and red points, respectively and check the difference between the two lines, we see that there is substantial difference between both groups. This difference is what we would get when we run a regression on all points. It indicates a positive treatment effect.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>However, the lines clearly don’t fit the data very well because there does not seem to be a linear relationship. To account for non-linearities, you can introduce e.g.&nbsp;square terms to the regression, here <span class="math inline">\(Z^2\)</span>. Then, the fit improves, in particular for the untreated data points. But what happened to the treatment effect? Now there is negative treatment effect smaller in magnitude than the previous positive treatment effect. We already see that the estimate is highly dependent on the choice of our particular model. This is why we should always put a lot of consideration into choosing the right model (which is not necessarily the one with the largest or desired treatment effect).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>But let’s think about what we would have to do to adjust for the confounder <span class="math inline">\(Z\)</span>. Ideally, we would like to compare treated and control group in an area where both groups are present. So the lower and upper region should actually be left out. Only where there is overlap of both groups, we can compare apples with apples. Focusing only on this (somewhat arbitrary) data points and drawing the lines and curves for both specifications of the regression, we get another different result. Now it seems, that there is no effect at all.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>So, how do we know what units to select, especially when there is more than one dimension? We will explore some techniques in the following sections but the short answer is: we need to create a balance for vales of all confounding variables treatment and control group, i.e.&nbsp;treatment and control group should be as similar as possible. And of course, we also need to assume, that all confounding variables are observed.</p>
</section>
<section id="subclassification-estimator" class="level1">
<h1>Subclassification Estimator</h1>
<p>Although not often used in practice, the subclassification estimator is an intuitive way of thinking about matching comparable observations and thereby controlling for confounders.</p>
<p>Essentially, the subclassification estimator estimates local treatment effects withing small groups that share the same values for (confounding) covariates. Sometimes, values does not need to be the same but only similar, e.g.&nbsp;for continuous variables like age it is very unlikely to find another observation unit with the exact same birthday, so you would define e.g.&nbsp;a year. By only comparing observations in a small subgroup as defined by the covariates, conditional independence is ensured.</p>
<p>Imagine, that a treatment was not randomly assigned for women and men and sex also plays a role for the outcome as well. One imaginary example could be the effect of a trainee program on later salary that was advertised more heavily to women and therefore more women participated. And being a women might also have an impact on salary. Then, we have the situation of a confounding variable, sex, and to control for it, we estimate a treatment effect for women and a treatment effect for men and average the effects weighted by the respective subsample size.</p>
<p>To check how that affects the estimated treatment effect we can simulate some data according to the variable relationships.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>confounder <span class="ot">&lt;-</span> <span class="st">'dag {</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">D [exposure,pos="0.000,0.000"]</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">Y [outcome,pos="2.000,0.000"]</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">Z [pos="1.000,1.000"]</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">Z -&gt; D</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">Z -&gt; Y</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="st">D -&gt; Y</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(confounder) <span class="sc">+</span> <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># number of observations</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e+3</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># variables</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">rbernoulli</span>(n, <span class="fl">0.5</span>) <span class="co"># 0 =&gt; Male, 1 =&gt; Female</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">rbernoulli</span>(n, <span class="at">p =</span> <span class="fu">if_else</span>(Z, <span class="fl">0.65</span>, <span class="fl">0.35</span>)) <span class="co"># 1 =&gt; Treat, 0 =&gt; Control</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fl">0.2</span><span class="sc">*</span>D <span class="sc">-</span> <span class="fl">0.1</span><span class="sc">*</span>Z <span class="sc">+</span> <span class="fu">rnorm</span>(n, <span class="dv">5</span>, <span class="fl">0.1</span>) <span class="co"># =&gt; e.g. Salary</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Z =</span> Z,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">D =</span> D,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> Y</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math inline">\(Z\)</span> is the confounder, <span class="math inline">\(D\)</span> the treatment and <span class="math inline">\(Y\)</span> is the outcome. As you can see both <span class="math inline">\(D\)</span> and <span class="math inline">\(Y\)</span> are related to <span class="math inline">\(Z\)</span> and <span class="math inline">\(Y\)</span> is influenced by both <span class="math inline">\(D\)</span> and $Z$. But we are only interested in the effect of <span class="math inline">\(D\)</span> on <span class="math inline">\(Z\)</span> and want to isolate it. From the commands, we know that the true causal effect of <span class="math inline">\(D\)</span> on <span class="math inline">\(Y\)</span> is 0.2.</p>
<p>Let’s see what a naive comparison would return, where we would just compare average salary of the individuals who have participated in the trainee program are compared to the individuals who have not participated.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Naive comparison</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#broom::tidy(lm(Y ~ D, df))</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>E_0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(df[df<span class="sc">$</span>D<span class="sc">==</span>F, ]<span class="sc">$</span>Y)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>E_1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(df[df<span class="sc">$</span>D<span class="sc">==</span>T, ]<span class="sc">$</span>Y)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>E_1 <span class="sc">-</span> E_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.16</code></pre>
</div>
</div>
<p>Due to confounding, the naive comparison cannot reconstruct our implemented treatment effect and is off. We should get closer if we account for confounding by taking averages treatment effects for men and women separately.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subclassification estimator (subclasses: Z = 0 and Z = 1)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># E(Z, D)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>E_00 <span class="ot">&lt;-</span> <span class="fu">mean</span>(df[(df<span class="sc">$</span>Z<span class="sc">==</span>F <span class="sc">&amp;</span> df<span class="sc">$</span>D<span class="sc">==</span>F), ]<span class="sc">$</span>Y)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>E_10 <span class="ot">&lt;-</span> <span class="fu">mean</span>(df[(df<span class="sc">$</span>Z<span class="sc">==</span>T <span class="sc">&amp;</span> df<span class="sc">$</span>D<span class="sc">==</span>F), ]<span class="sc">$</span>Y)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>E_01 <span class="ot">&lt;-</span> <span class="fu">mean</span>(df[(df<span class="sc">$</span>Z<span class="sc">==</span>F <span class="sc">&amp;</span> df<span class="sc">$</span>D<span class="sc">==</span>T), ]<span class="sc">$</span>Y)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>E_11 <span class="ot">&lt;-</span> <span class="fu">mean</span>(df[(df<span class="sc">$</span>Z<span class="sc">==</span>T <span class="sc">&amp;</span> df<span class="sc">$</span>D<span class="sc">==</span>T), ]<span class="sc">$</span>Y)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Weighted by K</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="fu">mean</span>(Z)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>K<span class="sc">*</span>(E_11<span class="sc">-</span>E_10) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>K)<span class="sc">*</span>(E_01 <span class="sc">-</span> E_00)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.19</code></pre>
</div>
</div>
<p>And in fact, now we are really close to the true treatment effect. The remaining difference is caused by randomness in our sampling process.</p>
<p>This way, we have closed the backdoor and are able to retrieve the causal effect. However, note that the effect can only be causally interpreted, if sex is the only confounding variable. If there are more confounders, we have to build smaller groups that are defined by value combinations of all confounders, which will at some point lead groups that are extremely small or maybe even empty. This is called the curse of dimensionality and is one reason why the subclassification estimator is rarely used in practice.</p>
</section>
<section id="matching-as-a-concept" class="level1">
<h1>Matching as a Concept</h1>
<p>In general, the outcome of a matching method are weights for each observation based on one or several matching variables, for some matching methods the weights are either 0 or 1 but there are also a lot of methods that give weights between 0 and 1 to observations.</p>
<p>The matching variables need to cover the variables that can, when adjusted on, block all backdoor paths between our treatment variable and the outcome. Then, the treatment effect is computed as a weighted mean of the outcomes for the treatment and control group.</p>
<p>Matching methods can be classified into two main approaches: matching based on (1) distance and (2) matching based on propensity scores.</p>
<ol type="1">
<li><p>Distance: Observations are similar if they have similar covariates (or similar values for the matching variables). This approach minimizes the distance between observations in treatment and control group based on their covariate values.</p></li>
<li><p>Propensity: Observations are similar if they are equally likely to be treated, i.e.&nbsp;matching variables are used to compute how likely an observation is to be in treatment group, regardless whether it actually is in the treatment or control group.</p></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can now outline a structure for the general process of matching that applies to all methods.</p>
<p>First, it starts with some kind of preprocessing, which is a “manual” part, where you use all information about the causal mechanisms that you have. Essentially, it forces you to look at the DAG you can draw based on all your theoretical knowledge and thoughts, and particularly what you know about the treatment assignment. In observational studies, this will leave you with a sample that is different from your raw sample. In randomized studies, it might be the same as you do not have to for example close a backdoor path.</p>
<p>Then, using this preprocessed data you can build your model to estimate the treatment effect.</p>
<p>As already mentioned, another difference across methods is whether observations are compared to matches, which classify other observations as either in our out or compared to matched weighted samples, where each observation obtains a different weight depending on how close they are. For matches, you have to decide how many to include or what the worst acceptable match is while for matched weighted samples you need to decide how weights decay with distance.</p>
<p>Now, let’s look at some methods in detail.</p>
<section id="single-matching-variable" class="level2">
<h2 class="anchored" data-anchor-id="single-matching-variable">Single Matching Variable</h2>
<p>Probably the most simple method, though rarely applied in practice, is matching on a single variable. Its rare use in practice is due to the fact that matching on a single variable is only applicable if there is only one backdoor path that can be closed by this matching variable.</p>
<p>But for ease of explanation, we’ll have a look at it.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>confounder <span class="ot">&lt;-</span> <span class="st">'dag {</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="st">D [exposure,pos="0.000,0.000"]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">Y [outcome,pos="2.000,0.000"]</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="st">Z [pos="1.000,1.000"]</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="st">Z -&gt; D</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="st">Z -&gt; Y</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="st">D -&gt; Y</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag</span>(confounder) <span class="sc">+</span> </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="dv">1</span>, <span class="at">label =</span> <span class="st">"Z fixed at constant level"</span>) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>!!! EXAMPLE:</p>
<p>credit card holders, monthly bills, repayment status (pay on time, delay payment) April - September</p>
<ol start="4" type="A">
<li>being late April &lt;- size of bill in April -&gt; (Y) being late Sept</li>
</ol>
<section id="coarsened-exact-matching" class="level3">
<h3 class="anchored" data-anchor-id="coarsened-exact-matching">(Coarsened) Exact Matching</h3>
<p>!!! pick one observation. define distance. single or multiple comparables.</p>
<p>We are trying to select observations in the control group that are similar to those in the treated group. To do so, we need to define what similar means. Here, we will say that similar observations are observations that share similar values for our matching variable (size of bill in April). By enforcing treatment and control group to have little variation in the matching variable, we close the backdoor. Only when the backdoor variable varies, it can induce changes in treatment and outcome and when we keep it at a certain level, the only effect from treatment to outcome is the direct effect.</p>
<p>How many? With our without replacement? Tradeoff between bias and variance (more matches, less variance and more bias) (Matching with replacement less bias because better matches and is not order-dependent)</p>
<ul>
<li><p>one-to-one matching: selecting the best match</p></li>
<li><p>top <span class="math inline">\(k\)</span> matching: k-nearest-neighbor matching</p></li>
<li><p>all “acceptable” matches: every match by some metric of acceptability (hard to define).</p></li>
</ul>
</section>
<section id="matched-weighted-sample" class="level3">
<h3 class="anchored" data-anchor-id="matched-weighted-sample">Matched weighted sample</h3>
<p>Now we will move away from a an observation being in or out depending on whether it is a best match to some unit. Instead we use an alternate approach that works by looking at all control observations and checking how close they are to treated observations. An observation is neither in our out but receives a weight depending on its similarity to a treated observation. The closer a control observation is to a treatment observation, the higher its weight.</p>
<p>How to construct weights?</p>
<ul>
<li><p>Kernel matching: kernel function takes difference and returns weight. Weight eventually gets to zero. Better matches obtain higher weights than less-good matches, bad matches obtain weight of zero. Different kinds of kernels.</p></li>
<li><p>Inverse probability weighting: specifically designed for use with propensity scores. Each observation is weighted by the inverse of the probability for its own treatment status. Simply put, atypical observations receive a high weight, so if you were actually treated which was unlikely based on your covariates, you receive a high weight.</p></li>
</ul>
<p>!!! PLOT: One-to-one matching (color of controls) vs weight matching (size of controls)</p>
<p>Comparison: selecting matches more intuitive and easier to implement but more sensitive. weights to account for quality of matches</p>
</section>
</section>
<section id="application-multiple-matching-variables" class="level2">
<h2 class="anchored" data-anchor-id="application-multiple-matching-variables">Application: Multiple Matching Variables</h2>
<p>Let us imagine, you want to reduce the number of sick days in your company by implementing a health program that employees are free to participate in. By learning about how to improve their health, you expect your employees to call in sick less frequently.</p>
<p>Now you already see that the treatment, participation in the health program, is on a voluntary basis and therefore treatment assignment might be confounded by variables such as age and initial health status. Older and sicker people might be more interested to learn about techniques and procedures to improve their health and also might benefit more from the program. Also, initial health status might be affected by age.</p>
<p>We can use a DAG to think about the correct identification strategy.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define DAG</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>dag_model <span class="ot">&lt;-</span> <span class="st">'dag {</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="st">  bb="0,0,1,1"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="st">  "Health Program" [exposure,pos="0.25,0.2"]</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="st">  "Initial Health Status" [pos="0.35,0.25"]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="st">  "Sick Days" [outcome,pos="0.35,0.2"]</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">  Age [pos="0.25,0.25"]</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="st">  "Initial Health Status" -&gt; "Health Program"</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="st">  "Initial Health Status" -&gt; "Sick Days"</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="st">  Age -&gt; "Health Program"</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="st">  Age -&gt; "Initial Health Status"</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="st">  Age -&gt; "Sick Days"</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="st">}'</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Directed Acyclic Graph</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag_status</span>(dag_model, <span class="at">text =</span> <span class="cn">FALSE</span>, <span class="at">use_labels =</span> <span class="st">"name"</span>) <span class="sc">+</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Directed Acyclic Graph with adjustment sets</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggdag_adjustment_set</span>(dag_model, <span class="at">shadow =</span> T, <span class="at">use_labels =</span> <span class="st">"name"</span>, <span class="at">text =</span> F) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="st">"none"</span>) <span class="sc">+</span>  <span class="co"># Turn off legend</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-28-2.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>There are two backdoor paths that we need to close, initial health status and age.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">adjustmentSets</span>(dag_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{ Age, Initial Health Status }</code></pre>
</div>
</div>
<p>A naive estimate would be</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Naive estimation (not accounting for backdoors)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>model_naive <span class="ot">&lt;-</span> <span class="fu">lm</span>(sick_days <span class="sc">~</span> health_program, <span class="at">data =</span> df)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(model_naive)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term               estimate std.error statistic   p.value
  &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)            7.26    0.0331     219.  0        
2 health_programTRUE     1.25    0.0465      26.9 2.30e-154</code></pre>
</div>
</div>
<p>which is different from the !!! TRUE TREATMENT EFFECT.</p>
<section id="coarsened-exact-matching-1" class="level3">
<h3 class="anchored" data-anchor-id="coarsened-exact-matching-1">(Coarsened) Exact Matching</h3>
<p>It is not difficult to extend the approaches defined above to multiple matching variables. Regarding the “selecting matches” approach, multiple variables are used for the computations instead of a single. Again, in case of exact matching, only observations that share the same values are matched in.</p>
<p>To perform Coarsened Exact Matching (CEM) you can use the <code>MatchIt</code> package in R. If you do not specify how to coarsen the data, it will be done automatically based on an algorithm.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Without specifying coarsening</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (1) Matching</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>cem <span class="ot">&lt;-</span> <span class="fu">matchit</span>(health_program <span class="sc">~</span> age <span class="sc">+</span> sick_days_before,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> df, </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">'cem'</span>, </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">estimand =</span> <span class="st">'ATE'</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariate balance</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cem)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = health_program ~ age + sick_days_before, data = df, 
    method = "cem", estimand = "ATE")

Summary of Balance for All Data:
                 Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
age                       46.4          44.6            0.18       0.99     0.054    0.087
sick_days_before           4.2           3.5            0.36       1.39     0.033    0.183


Summary of Balance for Matched Data:
                 Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max Std. Pair Dist.
age                       45.6          45.5           0.001       1.00     0.002    0.009            0.10
sick_days_before           3.8           3.8           0.021       0.97     0.002    0.042            0.22

Sample Sizes:
              Control Treated
All              4918    5082
Matched (ESS)    4600    4825
Matched          4914    5046
Unmatched           4      36
Discarded           0       0</code></pre>
</div>
</div>
<p>We are already closer to our true treatment effect.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_cem <span class="ot">&lt;-</span> <span class="fu">match.data</span>(cem)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (2) Estimation</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>model_cem <span class="ot">&lt;-</span> <span class="fu">lm</span>(sick_days <span class="sc">~</span> health_program, <span class="at">data =</span> df_cem, <span class="at">weights =</span> weights)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(model_cem)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term               estimate std.error statistic  p.value
  &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)           7.60     0.0325     234.  0       
2 health_programTRUE    0.522    0.0457      11.4 5.16e-30</code></pre>
</div>
</div>
<p>We can also provide values to coarsen the data in order to control for the number of subsamples. Again, we also check the balance.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom coarsening</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (1) Matching</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>cutpoints <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">age =</span> <span class="fu">seq</span>(<span class="dv">25</span>, <span class="dv">65</span>, <span class="dv">15</span>), <span class="at">sick_days_before =</span> <span class="fu">seq</span>(<span class="dv">3</span>, <span class="dv">22</span>, <span class="dv">5</span>))</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>cem_coars <span class="ot">&lt;-</span> <span class="fu">matchit</span>(health_program <span class="sc">~</span> age <span class="sc">+</span> sick_days_before,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> df, </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">method =</span> <span class="st">'cem'</span>, </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">estimand =</span> <span class="st">'ATE'</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cutpoints =</span> cutpoints)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariate balance</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cem_coars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = health_program ~ age + sick_days_before, data = df, 
    method = "cem", estimand = "ATE", cutpoints = cutpoints)

Summary of Balance for All Data:
                 Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
age                       46.4          44.6            0.18       0.99     0.054    0.087
sick_days_before           4.2           3.5            0.36       1.39     0.033    0.183


Summary of Balance for Matched Data:
                 Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max Std. Pair Dist.
age                       45.6          45.4           0.025        1.0     0.008    0.025            0.48
sick_days_before           3.9           3.7           0.124        1.1     0.012    0.094            0.58

Sample Sizes:
              Control Treated
All              4918    5082
Matched (ESS)    4762    4926
Matched          4916    5080
Unmatched           2       2
Discarded           0       0</code></pre>
</div>
</div>
<p>We can also visualize the subsamples and see how data points are weighted.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df_cem_coars <span class="ot">&lt;-</span> <span class="fu">match.data</span>(cem_coars)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot grid</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_cem_coars, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> sick_days_before,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">size =</span> weights, <span class="at">color =</span> <span class="fu">as.factor</span>(health_program))) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> .<span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="fu">data.frame</span>(<span class="at">y =</span> cutpoints<span class="sc">$</span>sick_days_before),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">intercept =</span> y, <span class="at">slope =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">data.frame</span>(<span class="at">y =</span> cutpoints<span class="sc">$</span>age),</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">xintercept =</span> y)) <span class="sc">+</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>Now, with fewer subsamples, the estimate is worse. It seems, the backdoors are not properly closed.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (2) Estimation</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>model_cem_coars <span class="ot">&lt;-</span> <span class="fu">lm</span>(sick_days <span class="sc">~</span> health_program, <span class="at">data =</span> df_cem_coars, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">weights =</span> weights)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(model_cem_coars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term               estimate std.error statistic  p.value
  &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)           7.52     0.0334     225.  0       
2 health_programTRUE    0.730    0.0468      15.6 2.94e-54</code></pre>
</div>
</div>
</section>
<section id="nearest-neighbor-matching" class="level3">
<h3 class="anchored" data-anchor-id="nearest-neighbor-matching">Nearest-Neighbor matching</h3>
<p>For nearest neighbor matching, the difference between two observations based on multiple variables is computed and reduced to a scalar. One of the most popular techniques used to find so called “nearest neighbors” is the euclidean distance.</p>
<p>We just have to change a few arguments and decide to use the Mahalanobis distance. Then, we check how similar treatment and control group are after matching.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (1) Matching</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># replace: one-to-one or one-to-many matching</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>nn <span class="ot">&lt;-</span> <span class="fu">matchit</span>(health_program <span class="sc">~</span> age <span class="sc">+</span> sick_days_before,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">distance =</span> <span class="st">"mahalanobis"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">replace =</span> T)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Covariate Balance</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(nn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = health_program ~ age + sick_days_before, data = df, 
    method = "nearest", distance = "mahalanobis", replace = T)

Summary of Balance for All Data:
                 Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max
age                       46.4          44.6            0.18       0.99     0.054    0.087
sick_days_before           4.2           3.5            0.33       1.39     0.033    0.183


Summary of Balance for Matched Data:
                 Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max Std. Pair Dist.
age                       46.4          46.4          -0.001          1     0.001    0.005           0.009
sick_days_before           4.2           4.2           0.001          1     0.000    0.000           0.002

Sample Sizes:
              Control Treated
All              4918    5082
Matched (ESS)    1783    5082
Matched          2693    5082
Unmatched        2225       0
Discarded           0       0</code></pre>
</div>
</div>
<p>This method also brings us closer to the true treatment effect.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_nn <span class="ot">&lt;-</span> <span class="fu">match.data</span>(nn)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (2) Estimation</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>model_nn <span class="ot">&lt;-</span> <span class="fu">lm</span>(sick_days <span class="sc">~</span> health_program, <span class="at">data =</span> df_nn, <span class="at">weights =</span> weights)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(model_nn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term               estimate std.error statistic  p.value
  &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)           8.00     0.0472    169.   0       
2 health_programTRUE    0.510    0.0584      8.72 3.28e-18</code></pre>
</div>
</div>
</section>
<section id="curse-of-dimensionality" class="level3">
<h3 class="anchored" data-anchor-id="curse-of-dimensionality">Curse of dimensionality</h3>
<p>With exact matching and nearest-neighbor matching you quickly run into the curse of dimensionality as your number of covariates grows. If you want to find matches based on very few dimensions, you are way more likely to find them as opposed to matches on a high number of dimensions, where it is very likely that you actually don’t find any matches at all.</p>
<p>Regarding exact matching, consider for example the situation with two covariates with each five different values. Then any observations will fall into one of 25 different cells that are given by the covariate value grid. And now imagine ten covariates with three different values: it already creates ~60k cells, which increases the likelihood of a cell being populated by only one or zero observations substantially. Then, estimation of treatment effects is not possible for many of the observations.</p>
<p>Nearest-neighbor matching is similarly affected by the curse of dimensionality. The more covariates you include, the less likely you are to find a good match. A quick solution, leaving out some covariates, can only be done if you are sure to not throw out any confounders.</p>
</section>
<section id="inverse-probability-weighting" class="level3">
<h3 class="anchored" data-anchor-id="inverse-probability-weighting">Inverse Probability weighting</h3>
<p>One way to deal with the curse of dimensionality is to use inverse probability weighting (IPW). We already mentioned it above, but let’s go into more detail.</p>
<p>We start by understanding what “probability” in inverse probability means. It is the predicted probability of treatment assignment based on the matching variables. So staying in the health program example, we use age and initial health status to predict how likely an employee is to participate in the health program. What we expect is that older and initially more sick people are more likely to participate opposed to younger and healthy people. To model this relationship, we could use for example logistic regression, a regression that predicts an outcome between zero and one. But you are also free to use any classification model that is out there, as here we are not only interested in explaining effects but only in obtaining the probability of treatment, also known as “propensity score”.</p>
<p>Here, we will use a logistic regression:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (1) Propensity scores</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>model_prop <span class="ot">&lt;-</span> <span class="fu">glm</span>(health_program <span class="sc">~</span> age <span class="sc">+</span> sick_days_before,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> df,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(model_prop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  term             estimate std.error statistic  p.value
  &lt;chr&gt;               &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)       -1.20     0.0997     -12.0  2.15e-33
2 age                0.0120   0.00210      5.69 1.27e- 8
3 sick_days_before   0.183    0.0116      15.7  7.89e-56</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add propensities to table</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>df_aug <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">augment_columns</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  model_prop, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  df,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type.predict =</span> <span class="st">"response"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">propensity =</span> .fitted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram of estimated propensities</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_aug, <span class="fu">aes</span>(<span class="at">x =</span> propensity)) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">alpha =</span> .<span class="dv">8</span>, <span class="at">color =</span> <span class="st">"white"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_match_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
</div>
</div>
<p>Having obtained the propensity score, you could again measure distances like described above and select matches. In fact, that is widely used matching method, known as propensity score matching. However, there are several reasons why this is not a good identification strategy<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, mainly, because same propensity score does not imply that observations have the same covariate values and this could actually increase the imbalance. Note, however, that same covariate values indeed imply the same propensity score.</p>
<p>Instead inverse probability has proven to be a more precise method, particularly when the sample is large enough. So what do we do with the probability/propensity scores in IPW? We use propensity score of an observation unit to in- or decrease its weights and thereby make some observations more important than others. The weight obtains as</p>
<p><span class="math display">\[
w_i = \frac{D_i}{\pi_i} + \frac{(1-D_i)}{(1-\pi_i)}
\]</span></p>
<p>where only one of the terms is always active as <span class="math inline">\(D_i\)</span> is either one or zero. Now we should better understand what “inverse probability weighting” actually means. It weights each observation by its inverse of its treatment probability.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>df_ipw <span class="ot">&lt;-</span> df_aug <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">ipw =</span> (health_program<span class="sc">/</span>propensity) <span class="sc">+</span> ((<span class="dv">1</span><span class="sc">-</span>health_program) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">-</span>propensity)))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>df_ipw <span class="sc">%&gt;%</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(health_program, age, sick_days_before, propensity, ipw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 5
   health_program   age sick_days_before propensity   ipw
   &lt;lgl&gt;          &lt;dbl&gt;            &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;
 1 FALSE           42.5                4      0.510  2.04
 2 FALSE           48.8                6      0.618  2.62
 3 FALSE           27.0                3      0.419  1.72
 4 FALSE           34.9                3      0.442  1.79
 5 FALSE           40.4                4      0.504  2.02
 6 TRUE            48.7                3      0.483  2.07
 7 FALSE           45.8                3      0.474  1.90
 8 FALSE           60.0                3      0.517  2.07
 9 FALSE           50.8                4      0.535  2.15
10 FALSE           48.1                3      0.481  1.93
# … with 9,990 more rows</code></pre>
</div>
</div>
<p>Imagine a case of an old employee with a very bad initial health status who chose to participate in the health program, i.e.&nbsp;<span class="math inline">\(D_i=1\)</span>. Based on his/her covariates, it was very likely that he choose to participate and consequently, his propensity score will be rather high, let’s assume it was 0.8, for demonstration. Then his/her weight would equal <span class="math inline">\(w_i = \frac{1}{0.8} = 1.25\)</span>.</p>
<p>Compared to that, what weight would a young and healthy person that choose to participate in the program obtain? Let’s say his/her probability of participating would be 0.2. Then, his/her weight would be <span class="math inline">\(w_i = \frac{1}{0.2} = 5\)</span>. So we see, he/she would obtain a significantly higher weight.</p>
<p>In general, IPW weights atypical observations, like a young and healthy person deciding to participate, higher than typical observations. The same applies for both treatment and control group. If you want, you can check it out yourself.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (2) Estimation</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>model_ipw <span class="ot">&lt;-</span> <span class="fu">lm</span>(sick_days <span class="sc">~</span> health_program,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> df_ipw, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">weights =</span> ipw)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(model_ipw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term               estimate std.error statistic       p.value
  &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;
1 (Intercept)           7.85     0.0367    214.   0            
2 health_programTRUE    0.308    0.0521      5.92 0.00000000341</code></pre>
</div>
</div>
<p>Some propensity values are very extreme and therefore obtain an extreme weight. We should probably filter them out to improve our estimate.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_ipw <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(health_program, age, sick_days_before, propensity, ipw) <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(ipw))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 5
   health_program   age sick_days_before propensity   ipw
   &lt;lgl&gt;          &lt;dbl&gt;            &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;
 1 FALSE           61.4               19      0.953 21.3 
 2 FALSE           45.6               18      0.933 15.0 
 3 FALSE           57.7               17      0.931 14.5 
 4 FALSE           62.7               16      0.923 12.9 
 5 FALSE           45.9               17      0.921 12.7 
 6 FALSE           56.4               16      0.917 12.0 
 7 FALSE           59.5               15      0.905 10.5 
 8 FALSE           59.0               15      0.905 10.5 
 9 FALSE           57.0               15      0.903 10.3 
10 FALSE           41.3               15      0.885  8.68
# … with 9,990 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>model_ipw_trim <span class="ot">&lt;-</span> <span class="fu">lm</span>(sick_days <span class="sc">~</span> health_program,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> df_ipw <span class="sc">%&gt;%</span> <span class="fu">filter</span>(propensity <span class="sc">%&gt;%</span> <span class="fu">between</span>(<span class="fl">0.15</span>, <span class="fl">0.85</span>)),</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">weights =</span> ipw)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(model_ipw_trim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term               estimate std.error statistic  p.value
  &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)           7.63     0.0323     236.  0       
2 health_programTRUE    0.492    0.0457      10.8 8.16e-27</code></pre>
</div>
</div>
<p>Opposed to other methods, IPW, which is specifically designed for use with propensity scores, allows us to use all data in terms of number of observations and dimensions and the only decision we need to take is how to estimate the propensity score. It is important to note that the model does not need to predict as accurate as possible but it is more crucial that it accounts for all confounders.</p>
</section>
<section id="comparison" class="level3">
<h3 class="anchored" data-anchor-id="comparison">Comparison</h3>
<p>You see, that there many ways backdoors can be closed.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"Naive"</span> <span class="ot">=</span> model_naive,</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                                <span class="co">#"All"   = model_adj,</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"CEM1"</span>  <span class="ot">=</span> model_cem,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"CEM2"</span>  <span class="ot">=</span> model_cem_coars,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"NN"</span>    <span class="ot">=</span> model_nn,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"IPW1"</span>  <span class="ot">=</span> model_ipw,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"IPW2"</span>  <span class="ot">=</span> model_ipw_trim))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:center;"> Naive </th>
   <th style="text-align:center;"> CEM1 </th>
   <th style="text-align:center;"> CEM2 </th>
   <th style="text-align:center;"> NN </th>
   <th style="text-align:center;"> IPW1 </th>
   <th style="text-align:center;"> IPW2 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> 7.260 </td>
   <td style="text-align:center;"> 7.603 </td>
   <td style="text-align:center;"> 7.517 </td>
   <td style="text-align:center;"> 8.003 </td>
   <td style="text-align:center;"> 7.853 </td>
   <td style="text-align:center;"> 7.633 </td>
  </tr>
  <tr>
   <td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.033) </td>
   <td style="text-align:center;"> (0.033) </td>
   <td style="text-align:center;"> (0.033) </td>
   <td style="text-align:center;"> (0.047) </td>
   <td style="text-align:center;"> (0.037) </td>
   <td style="text-align:center;"> (0.032) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> health_programTRUE </td>
   <td style="text-align:center;"> 1.252 </td>
   <td style="text-align:center;"> 0.522 </td>
   <td style="text-align:center;"> 0.730 </td>
   <td style="text-align:center;"> 0.510 </td>
   <td style="text-align:center;"> 0.308 </td>
   <td style="text-align:center;"> 0.492 </td>
  </tr>
  <tr>
   <td style="text-align:left;box-shadow: 0px 1px">  </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.046) </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.046) </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.047) </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.058) </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.052) </td>
   <td style="text-align:center;box-shadow: 0px 1px"> (0.046) </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 10000 </td>
   <td style="text-align:center;"> 9960 </td>
   <td style="text-align:center;"> 9996 </td>
   <td style="text-align:center;"> 7775 </td>
   <td style="text-align:center;"> 10000 </td>
   <td style="text-align:center;"> 9956 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 </td>
   <td style="text-align:center;"> 0.068 </td>
   <td style="text-align:center;"> 0.013 </td>
   <td style="text-align:center;"> 0.024 </td>
   <td style="text-align:center;"> 0.010 </td>
   <td style="text-align:center;"> 0.003 </td>
   <td style="text-align:center;"> 0.011 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> R2 Adj. </td>
   <td style="text-align:center;"> 0.068 </td>
   <td style="text-align:center;"> 0.013 </td>
   <td style="text-align:center;"> 0.024 </td>
   <td style="text-align:center;"> 0.010 </td>
   <td style="text-align:center;"> 0.003 </td>
   <td style="text-align:center;"> 0.011 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> AIC </td>
   <td style="text-align:center;"> 45249.3 </td>
   <td style="text-align:center;"> 44933.4 </td>
   <td style="text-align:center;"> 45510.1 </td>
   <td style="text-align:center;"> 36480.9 </td>
   <td style="text-align:center;"> 47740.0 </td>
   <td style="text-align:center;"> 44855.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> BIC </td>
   <td style="text-align:center;"> 45270.9 </td>
   <td style="text-align:center;"> 44955.0 </td>
   <td style="text-align:center;"> 45531.8 </td>
   <td style="text-align:center;"> 36501.7 </td>
   <td style="text-align:center;"> 47761.6 </td>
   <td style="text-align:center;"> 44876.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Log.Lik. </td>
   <td style="text-align:center;"> −22621.658 </td>
   <td style="text-align:center;"> −22463.706 </td>
   <td style="text-align:center;"> −22752.070 </td>
   <td style="text-align:center;"> −18237.432 </td>
   <td style="text-align:center;"> −23866.986 </td>
   <td style="text-align:center;"> −22424.643 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> F </td>
   <td style="text-align:center;"> 725.685 </td>
   <td style="text-align:center;"> 130.395 </td>
   <td style="text-align:center;"> 243.514 </td>
   <td style="text-align:center;"> 76.090 </td>
   <td style="text-align:center;"> 34.994 </td>
   <td style="text-align:center;"> 115.600 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 2.32 </td>
   <td style="text-align:center;"> 2.28 </td>
   <td style="text-align:center;"> 2.34 </td>
   <td style="text-align:center;"> 2.45 </td>
   <td style="text-align:center;"> 3.69 </td>
   <td style="text-align:center;"> 3.22 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</section>
</section>
</section>
<section id="assumptions" class="level1">
<h1>Assumptions</h1>
<p>To obtain valid estimates with any matching estimator, we still need to fulfill some assumptions. Most important are the following:</p>
<ul>
<li><p>Conditional Independence: all backdoors needs to be closed so it has to be ensured that all confounders are in the set of matching variables.</p></li>
<li><p>Common Support: for treated units, there need to exist appropriate control units. Without a substantial overlap in the distribution of matching variables or the propensity score, estimating causal effects is impossible.</p></li>
</ul>
<p>Parts of these assumptions can be checked by looking at the balance of covariates. Useful metrics include summary statistics including means, standard deviations, difference-of-means test etc.</p>
<p>!!! Show raw balance and matched balance (Matching::MatchBalance or vtable::sujmtable)</p>
<p>If the degree balance is not satisfactory, you can change parameters of your matching method and do a new iteration until you are confident to have a good balance between treatment and control.</p>
<p>Having fulfilled the necessary assumptions allows the valid estimation of a treatment. It is interesting to note that, depending on what method you chose, a different kind of treatment effect is estimated. Most of the methods start with having a treated unit and search for matches (selecting or weighting) across the control units, which will return the average treatment effect on the treated, <span class="math inline">\(ATT\)</span>. By the same logic, these methods can also yield the average treatment effect on the untreated, <span class="math inline">\(ATU\)</span>.</p>
<p>Then, the average treatment effect can be estimated by</p>
<p><span class="math display">\[
ATE = p*ATT + (1-p)*ATU
\]</span></p>
<p>In case of IPW, <span class="math inline">\(ATE\)</span> is computed directly, as it changes the weights of units from both groups.</p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Matching methods are a very active research field and even thinking about the correct way to choose parameters in those methods offers a wide range of questions that there is no definite answer to. To some degree, choosing matching parameters is arbitrary. A benefit, however, is that after matching model dependence is reduced when using simple techniques like weighted means.</p>
<p>But how does it compare to using a simple linear regression? In one of the previous chapters, we said that closing back doors can also be achieved by including confounders into the regression equation. One difference is that when using regression, the <span class="math inline">\(ATE\)</span> points in direction where covariates have more variance, i.e.&nbsp;when there is a higher treatment variance for older people for example, they obtain a higher weight as compared to the matching approach. Another difference is that a regression hinges on the assumption of linearity, which we do not need to assume in matching approaches.</p>
</section>
<section id="assignment" class="level1">
<h1>Assignment</h1>
<p>Imagine, the following situation. You are running an online store and you one year ago, you introduced a plus membership to bind customers to your store and increase revenue. The plus memberships comes at a small cost for the customers, which is why not all of the customers subscribed.</p>
<p>Load the data, look at the variables and draw a DAG that you think shows the situation best. Then, compute</p>
<ul>
<li><p>a naive estimate</p></li>
<li><p>an estimate using coarsened exact matching (custom or default)</p></li>
<li><p>an estimate using nearest-neighbor matching</p></li>
<li><p>an estimate using inverse probability weighting</p></li>
</ul>
<p>and compare the results. Argue what estimates can be causally interpreted.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><a href="https://gking.harvard.edu/publications/why-propensity-scores-should-not-be-used-formatching" class="uri">https://gking.harvard.edu/publications/why-propensity-scores-should-not-be-used-formatching</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../content/toolbox/05_rct.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Randomized Controlled Trials</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../content/toolbox/07_did.html" class="pagination-link">
        <span class="nav-page-text">Difference-in-Differences</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>