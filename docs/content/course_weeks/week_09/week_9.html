<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.536">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>CAUSAL DATA SCIENCE FOR BUSINESS ANALYTICS - 9 - Difference-in-Differences (1/2)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../content/course_weeks/week_10/week_10.html" rel="next">
<link href="../../../content/course_weeks/week_08/week_8.html" rel="prev">
<link href="../../../images/favicon_cds_16x16.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script src="../../../site_libs/quarto-contrib/iconify-1.0.7/iconify-icon.min.js"></script>
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="../../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../../site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../../../styles.css">
</head>
<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../images/icon_cds.svg" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title"><b>CAUSAL DATA SCIENCE FOR BUSINESS ANALYTICS</b></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../../content/course_weeks/overview.html" aria-current="page"> 
<span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../content/organization/mattermost.html"> 
<span class="menu-text">Organization</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://communicating.tuhh.de/w-11-students/channels/cdsba_ss24"> 
<span class="menu-text"><iconify-icon inline="" icon="cib:mattermost" style="font-size: 1.25em;"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../content/course_weeks/week_01/week_1.html"><b>Weekly content</b></a></li><li class="breadcrumb-item"><a href="../../../content/course_weeks/week_09/week_9.html">9 - Difference-in-Differences (1/2)</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text"><b>Weekly content</b></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_01/week_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 - Introduction to Causal Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_02/week_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2 - Graphical Causal Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_03/week_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3 - Randomized Experiments &amp; Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_04/week_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4 - Matching</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_05/week_5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5 - Double Machine Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_06/week_6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6 - Effect Heterogeneity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_07/week_7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7 - Unobserved Confounding &amp; Instrumental Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_08/week_8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8 - Recap from week 5, 6, 7</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_09/week_9.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">9 - Difference-in-Differences (1/2)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_10/week_10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10 - Difference-in-Differences (2/2)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_11/week_11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11 - Synthetic Control (1/2)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_12/week_12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12 - Synthetic Control (2/2)</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text"><b>Optional reads</b></span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/optional_read/motivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motivation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/optional_read/prob.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probability Theory</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/optional_read/stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical Concepts</span></a>
  </div>
</li>
      </ul>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#slides-recap" id="toc-slides-recap" class="nav-link active" data-scroll-target="#slides-recap">Slides &amp; Recap</a></li>
  <li><a href="#panel-data" id="toc-panel-data" class="nav-link" data-scroll-target="#panel-data">Panel Data</a></li>
  <li><a href="#basic-differences-in-differences" id="toc-basic-differences-in-differences" class="nav-link" data-scroll-target="#basic-differences-in-differences">Basic differences-in-differences</a></li>
  <li><a href="#parallel-trends" id="toc-parallel-trends" class="nav-link" data-scroll-target="#parallel-trends">Parallel trends</a></li>
  <li><a href="#testing-for-parallel-trends" id="toc-testing-for-parallel-trends" class="nav-link" data-scroll-target="#testing-for-parallel-trends">Testing for parallel trends</a></li>
  <li><a href="#conditional-parallel-trends" id="toc-conditional-parallel-trends" class="nav-link" data-scroll-target="#conditional-parallel-trends">Conditional parallel trends</a></li>
  <li>
<a href="#att-conditional-on-covariates" id="toc-att-conditional-on-covariates" class="nav-link" data-scroll-target="#att-conditional-on-covariates">ATT conditional on covariates</a>
  <ul class="collapse">
<li><a href="#twfe" id="toc-twfe" class="nav-link" data-scroll-target="#twfe">TWFE</a></li>
  <li><a href="#doubly-robust-estimator" id="toc-doubly-robust-estimator" class="nav-link" data-scroll-target="#doubly-robust-estimator">Doubly robust estimator</a></li>
  <li><a href="#outcome-regression" id="toc-outcome-regression" class="nav-link" data-scroll-target="#outcome-regression">Outcome regression</a></li>
  <li><a href="#inverse-probability-weighting-regression" id="toc-inverse-probability-weighting-regression" class="nav-link" data-scroll-target="#inverse-probability-weighting-regression">Inverse probability weighting regression</a></li>
  </ul>
</li>
  <li><a href="#assignment" id="toc-assignment" class="nav-link" data-scroll-target="#assignment">Assignment</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../content/course_weeks/week_01/week_1.html"><b>Weekly content</b></a></li><li class="breadcrumb-item"><a href="../../../content/course_weeks/week_09/week_9.html">9 - Difference-in-Differences (1/2)</a></li></ol></nav><div class="quarto-title">
<h1 class="title">9 - Difference-in-Differences (1/2)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="slides-recap" class="level2"><h2 class="anchored" data-anchor-id="slides-recap">Slides &amp; Recap</h2>
<iframe style="width: 100%; height: 45vw; max-height: 50vh;" frameborder="0" allowfullscreen="" src="https://tuhhstartupengineers-classroom.github.io/ss24-causal-data-science/slides/08_did.html">
</iframe>
<p>So far, we have primarily discussed cross-sectional data, where each unit is observed only once. However, sometimes you can observe units over multiple time periods, resulting in panel data. This allows us to see how a unit changes before and after a treatment. When randomization isn’t feasible, panel data is the best alternative for identifying causal effects. The most well-known method for estimating this effect is called difference-in-differences (DiD).</p>
</section><section id="panel-data" class="level2"><h2 class="anchored" data-anchor-id="panel-data">Panel Data</h2>
<p>In marketing, randomization is often impractical because you cannot always control who receives the treatment. For instance, let’s say you decide to place billboards in a city to advertise your app, aiming to measure the resulting number of downloads attributed to these billboards. You will advertise in some cities but not in others, creating a geo experiment. Additionally, you will track several time-invariant covariates:</p>
<ul>
<li>
<span class="math inline">\(age_i\)</span>: age average in city <span class="math inline">\(i\)</span>
</li>
<li>
<span class="math inline">\(population\_size_i\)</span>: integer indicating population size of city <span class="math inline">\(i\)</span>
</li>
<li>
<span class="math inline">\(user\_share_i\)</span>: initial share of app users prior to observation period in city <span class="math inline">\(i\)</span>
</li>
<li>
<span class="math inline">\(competitor\_price_i\)</span>: average of competitor app price in that given area</li>
</ul>
<p>Unlike your competitor, your app is free to download, and you plan to generate revenue within the app. Our observed units are cities <span class="math inline">\(i\)</span> over multiple time periods <span class="math inline">\(t\)</span>. Let’s have a look at the <a href="https://cloud.tuhh.de/index.php/s/etes53YbZxiYtME">data</a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load tidyverse</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read data</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"mkt_panel.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print first lines</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   city month post downloads ever_treated age user_share population_size competitor_price
1     1     1    0       418            1  44       0.23              15              2.2
2     1     2    0       437            1  44       0.23              15              2.2
3     1     3    0       472            1  44       0.23              15              2.2
4     1     4    0       460            1  44       0.23              15              2.2
5     1     5    0       509            1  44       0.23              15              2.2
6     1     6    0       524            1  44       0.23              15              2.2
7     1     7    0       568            1  44       0.23              15              2.2
8     1     8    0       605            1  44       0.23              15              2.2
9     1     9    1       640            1  44       0.23              15              2.2
10    2     1    0       461            1  45       0.23               8              3.1</code></pre>
</div>
</div>
<p>We see that for city <span class="math inline">\(i=1\)</span>, we have eight months with <span class="math inline">\(post = 0\)</span> and 1 month with <span class="math inline">\(post = 1\)</span>. The outcome changes over time but the covariates are time invariant. Please also note that the treatment indicator indicates whether a unit was “ever” treated.</p>
<p>When counting the number of control and treatment units per period, we’ll see that we have a complete panel without any missing data.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Panel data overview</span></span>
<span><span class="va">df_piv</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">ever_treated</span>, <span class="va">post</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span></span>
<span>    names_from <span class="op">=</span> <span class="st">"ever_treated"</span>,</span>
<span>    values_from <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>    names_prefix <span class="op">=</span> <span class="st">"ever_treated_"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">df_piv</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
  month  post ever_treated_0 ever_treated_1
  &lt;int&gt; &lt;dbl&gt;          &lt;int&gt;          &lt;int&gt;
1     1     0             91            109
2     2     0             91            109
3     3     0             91            109
4     4     0             91            109
5     5     0             91            109
6     6     0             91            109
7     7     0             91            109
8     8     0             91            109
9     9     1             91            109</code></pre>
</div>
</div>
</section><section id="basic-differences-in-differences" class="level2"><h2 class="anchored" data-anchor-id="basic-differences-in-differences">Basic differences-in-differences</h2>
<p>Not always you will have several pre-treatment periods and DiD already works when you only observe one period before and one period after the treatment. So let’s image that scenario and later re-introduce the other pre-treatment periods.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Last pre-treatment and post-treatment period</span></span>
<span><span class="va">df_2p</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">8</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">df_2p</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">ever_treated</span>, <span class="va">post</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  month ever_treated post   n
1     8            0    0  91
2     8            1    0 109
3     9            0    1  91
4     9            1    1 109</code></pre>
</div>
</div>
<p>Because we observe both control and treated units before and after the treatment, we can compute the treatment effect <span class="math inline">\(\tau_{\text{DiD}}\)</span> using the difference-in-differences method. This involves first calculating the difference in outcomes between the treated and control groups after the treatment, then subtracting the difference in outcomes between these groups before the treatment. This double differencing helps isolate the treatment effect.</p>
<p><span class="math display">\[
\begin{aligned}
\tau_{\text{DiD}} = \underbrace{\mathbb{E}[Y_{i,1} | D_i=1] - \mathbb{E}[Y_{i,1} | D_i=0]}_{\text{difference in post-treatment}} \\ - \underbrace{(\mathbb{E}[Y_{i,0} | D_i=1] - \mathbb{E}[Y_{i,0} | D_i=0])}_{\text{difference in pre-treatment}}
\end{aligned}
\]</span></p>
<p>In a slightly different and cleaned up notation, we see that the difference we obtain is only attributed to the treatment.</p>
<div class="grid">
<div class="g-col-2">

</div>
<div class="g-col-8">
<table class="table">
<colgroup>
<col style="width: 23%">
<col style="width: 8%">
<col style="width: 38%">
<col style="width: 22%">
<col style="width: 7%">
</colgroup>
<thead><tr class="header">
<th>Group</th>
<th>Time</th>
<th>Outcome</th>
<th>1st Difference</th>
<th>DiD</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Treatment (D=1)</td>
<td>0</td>
<td><span class="math inline">\(Y= Y_{T=0, D=1}\)</span></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>1</td>
<td><span class="math inline">\(Y = Y_{T=0,D=1} + T + D\)</span></td>
<td><span class="math inline">\(T +D\)</span></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td><span class="math inline">\(D\)</span></td>
</tr>
<tr class="even">
<td>Control (D=0)</td>
<td>0</td>
<td><span class="math inline">\(Y = Y_{T=0, D=0}\)</span></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>1</td>
<td><span class="math inline">\(Y = Y_{T=0, D=0} + T\)</span></td>
<td><span class="math inline">\(T\)</span></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="g-col-2">

</div>
</div>
<p><span style="color:#FF7E15"><strong>Task 1:</strong></span> With the help of the formula/table, compute <span class="math inline">\(\tau_{\text{DiD}}\)</span>. What is the interpretation with regard to our example?</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 1: group by treatment group and period</span></span>
<span><span class="va">did_p2</span> <span class="op">&lt;-</span> <span class="va">df_2p</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ever_treated</span>, <span class="va">post</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">downloads</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">did_p2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  ever_treated  post     y
         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1            0     0  517.
2            0     1  546.
3            1     0  566.
4            1     1  609.</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Step 2: Extract values and doubly differencing</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">did_p2</span>, <span class="op">{</span></span>
<span>  <span class="va">y_00</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">ever_treated</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">post</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span></span>
<span>  <span class="va">y_01</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">ever_treated</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">post</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">y_10</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">ever_treated</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">post</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span></span>
<span>  <span class="va">y_11</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">ever_treated</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">post</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="op">(</span><span class="va">y_11</span> <span class="op">-</span> <span class="va">y_10</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">y_01</span> <span class="op">-</span> <span class="va">y_00</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 15</code></pre>
</div>
</div>
<p>Alternatively, we can use regression-based approaches to estimate the treatment effect. Two different approaches yielding equivalent results are:</p>
<ol type="1">
<li>Two-way fixed effects (TWFE).</li>
</ol>
<p><span class="math display">\[
Y_{i,t} = \alpha_i + \gamma_t + \tau_{\text{DiD}} (D_i \times t) + \epsilon_{i,t}
\]</span></p>
<ol start="2" type="1">
<li>Regression with treatment and time dummy, as well as interaction of treatment and time.</li>
</ol>
<p><span class="math display">\[
Y_{i,t} = \alpha + \beta D_i + \gamma t + \tau_{\text{DiD}} (D_i \times t) + \epsilon_{i,t}
\]</span> <span style="color:#FF7E15"><strong>Task 2:</strong></span> Perform both approaches and report the estimated coefficient.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># (1)</span></span>
<span><span class="va">mod_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">downloads</span> <span class="op">~</span> <span class="va">ever_treated</span><span class="op">:</span><span class="va">post</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">city</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df_2p</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Coefficient</span></span>
<span><span class="va">coef_mod_1</span> <span class="op">&lt;-</span> <span class="va">mod_1</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="st">"ever_treated:post"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%.2f"</span>, <span class="va">coef_mod_1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "14.86"</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># (2)</span></span>
<span><span class="va">mod_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">downloads</span> <span class="op">~</span> <span class="va">ever_treated</span><span class="op">*</span><span class="va">post</span>, data <span class="op">=</span> <span class="va">df_2p</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = downloads ~ ever_treated * post, data = df_2p)

Residuals:
   Min     1Q Median     3Q    Max 
-489.1  -54.8   -3.8   55.5  564.1 

Coefficients:
                  Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)          516.7       11.3   45.93   &lt;2e-16 ***
ever_treated          48.8       15.2    3.20   0.0015 ** 
post                  29.0       15.9    1.82   0.0691 .  
ever_treated:post     14.9       21.6    0.69   0.4908    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 107 on 396 degrees of freedom
Multiple R-squared:  0.0911,    Adjusted R-squared:  0.0842 
F-statistic: 13.2 on 3 and 396 DF,  p-value: 3.01e-08</code></pre>
</div>
</div>
<p>For two-way fixed effects estimation, we can generally also use the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> command which we have used for so many applications already. However, it is recommended to use the <code>fixest</code> package due to its increased speed and focus on fixed effects. As it is the workhorse of many other packages, let’s get it installed.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"fixest"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The formula notation is slightly different as we separate the fixed effects using the | operator. This approach allows the algorithm to converge faster, and the fixed effects will not appear in the regression summary. Since fixed effects are typically not of primary interest and we often have a large number of them, this simplification is quite convenient.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Faster way for (1)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lrberge.github.io/fixest/">fixest</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">downloads</span> <span class="op">~</span> <span class="va">ever_treated</span><span class="op">:</span><span class="va">post</span> <span class="op">|</span> <span class="va">city</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">df_2p</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: downloads
Observations: 400
Fixed-effects: city: 200,  month: 2
Standard-errors: Clustered (city) 
                  Estimate Std. Error t value  Pr(&gt;|t|)    
ever_treated:post       15          3       5 1.399e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 10.4     Adj. R2: 0.98258 
             Within R2: 0.112107</code></pre>
</div>
</div>
</section><section id="parallel-trends" class="level2"><h2 class="anchored" data-anchor-id="parallel-trends">Parallel trends</h2>
<p>Here, where we only have two time period, we need to rely on one assumption to hold: the <strong>parallel trends assumption</strong>. Opposed to methods where we just know one outcome - the “after” outcome, regardless of whether a unit received or did not receive treatment - we do not have to assume that the potential outcomes are equal <span class="math inline">\((Y_1(0)-Y_0(0)) \perp\!\!\!\perp T\)</span>. That is a big difference, because do not have to assume that observation units are similar in all their characteristics. Instead DiD hinges on a different assumption, the parallel trends assumption. It says that, in absence of treatment for both groups, they would be expected to evolve similarly over time. In other words, we do not expect the potential outcome to be similar, but only the change of outcomes from before to after. It implies that there is no factor that has only an impact on just one of the groups.</p>
<p><span class="math display">\[
\mathbb{E}[Y_{i,t=1}(0) - Y_{i,t=0}(0) | D_i=1] = \mathbb{E}[Y_{i,t=1}(0) - Y_{i,t=0}(0) | D_i=0]
\]</span></p>
<p>While the parallel trends assumption is generally untestable, in the case with only two periods, we are particularly in the dark.</p>
<p>Graphically, what we assume is that the treated line would have evolved similarly to the control line - as depicted by the dotted line. What can we do to increase the plausibility of this assumption?</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">y10</span> <span class="op">&lt;-</span> <span class="va">did_p2</span><span class="op">[</span><span class="va">did_p2</span><span class="op">$</span><span class="va">ever_treated</span><span class="op">==</span><span class="fl">1</span> <span class="op">&amp;</span> <span class="va">did_p2</span><span class="op">$</span><span class="va">post</span><span class="op">==</span><span class="fl">0</span>, <span class="op">]</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="va">y01</span> <span class="op">&lt;-</span> <span class="va">did_p2</span><span class="op">[</span><span class="va">did_p2</span><span class="op">$</span><span class="va">ever_treated</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">did_p2</span><span class="op">$</span><span class="va">post</span><span class="op">==</span><span class="fl">1</span>, <span class="op">]</span><span class="op">$</span><span class="va">y</span></span>
<span><span class="va">y00</span> <span class="op">&lt;-</span> <span class="va">did_p2</span><span class="op">[</span><span class="va">did_p2</span><span class="op">$</span><span class="va">ever_treated</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">did_p2</span><span class="op">$</span><span class="va">post</span><span class="op">==</span><span class="fl">0</span>, <span class="op">]</span><span class="op">$</span><span class="va">y</span></span>
<span></span>
<span><span class="va">data_cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">y10</span>, <span class="va">y10</span> <span class="op">+</span> <span class="op">(</span><span class="va">y01</span><span class="op">-</span><span class="va">y00</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">did_p2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">post</span>, y <span class="op">=</span> <span class="va">y</span>, group <span class="op">=</span> <span class="va">ever_treated</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">ever_treated</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_cf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">y</span>, group <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"#5AFFC5"</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">.5</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: The `scale_name` argument of `discrete_scale()` is deprecated as of ggplot2 3.5.0.</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_9_files/figure-html/unnamed-chunk-10-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="week_9_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="testing-for-parallel-trends" class="level2"><h2 class="anchored" data-anchor-id="testing-for-parallel-trends">Testing for parallel trends</h2>
<p>There is some remedy when we are able to observe multiple periods prior to the treatment. By comparing trends before treatment between the treatment and control groups, researchers aim to demonstrate that there was no significant difference prior to the treatment. The logic is that if there was no difference before treatment, any difference observed after the treatment is likely due to the treatment itself.</p>
<p>However, even that cannot provide full certainty about the parallel trends assumption. There may still be unobserved factors that could affect the treatment. Nevertheless, event studies are a useful tool for arguing that the treatment and control groups are comparable.</p>
<p>Let’s now switch back to the dataset with multiple pre-treatment periods and begin by plotting the observed outcomes over time. This will help us determine if there are converging or diverging trends between the treatment and control groups. By visualizing these trends, we can already assess whether the parallel trends assumption holds before the treatment.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Outcomes across time by group</span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">month</span>,</span>
<span>    y <span class="op">=</span> <span class="va">downloads</span>,</span>
<span>    fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">ever_treated</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">ever_treated</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun.data <span class="op">=</span> <span class="va">mean_se</span>, geom <span class="op">=</span> <span class="st">"point"</span>, alpha <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun.data <span class="op">=</span> <span class="va">mean_se</span>, geom <span class="op">=</span> <span class="st">"line"</span>, alpha <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html">stat_summary</a></span><span class="op">(</span>fun.data <span class="op">=</span> <span class="va">mean_se</span>, geom <span class="op">=</span> <span class="st">"ribbon"</span>, alpha <span class="op">=</span> <span class="fl">.2</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">8.5</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_9_files/figure-html/unnamed-chunk-11-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="week_9_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
<p>At the first glance, prior to the treatment, the outcomes seem to evolve in parallel. However, a better way is to actually perform statistical tests and check the hypothesis that the evolution of both groups is parallel. For each difference between two pre-treatment periods, the should be no difference in the evolution of the outcomes across the treatment groups.</p>
<p><span style="color:#FF7E15"><strong>Task 3a:</strong></span> Subset the data so you can perform test for pre-trends between the pre-treatment months 7 and 8 using the TWFE approach from above.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_placebo</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>post <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">8</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">downloads</span> <span class="op">~</span> <span class="va">ever_treated</span><span class="op">:</span><span class="va">post</span> <span class="op">|</span> <span class="va">city</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">df_placebo</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: downloads
Observations: 400
Fixed-effects: city: 200,  month: 2
Standard-errors: Clustered (city) 
                  Estimate Std. Error t value Pr(&gt;|t|) 
ever_treated:post       -2        2.9   -0.68  0.49595 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 10.4     Adj. R2: 0.980199
             Within R2: 0.002316</code></pre>
</div>
</div>
<p><span style="color:#FF7E15"><strong>Task 3b:</strong></span> Subset the data so you can perform test for pre-trends between the pre-treatment months 3 and 8 using the TWFE approach from above.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_placebo</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>post <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">8</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">downloads</span> <span class="op">~</span> <span class="va">ever_treated</span><span class="op">:</span><span class="va">post</span> <span class="op">|</span> <span class="va">city</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">df_placebo</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: downloads
Observations: 400
Fixed-effects: city: 200,  month: 2
Standard-errors: Clustered (city) 
                  Estimate Std. Error t value   Pr(&gt;|t|)    
ever_treated:post      -17        4.8    -3.6 0.00033698 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 16.7     Adj. R2: 0.95883 
             Within R2: 0.063532</code></pre>
</div>
</div>
<p>With this approach, you would have to iterate through quite a lot of combinations. Another approach would be to add “fake” post columns to the data frame and interact them with the treatment indicator.</p>
<p><span style="color:#FF7E15"><strong>Task 4:</strong></span> Subset the data so you can perform test for pre-trends between ALL two arbitrary pre-treatment periods using the TWFE approach from above. You’ll need to create new columns with e.g.&nbsp;<code>post_t = if_else(month == t, 1, 0)</code>, where <code>t</code> is a treatment period and introduce new interactions into the formula.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_placebo_all</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    post_1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    post_2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    post_3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    post_4 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    post_5 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    post_6 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">6</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    post_7 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">7</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>    post_8 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="fl">8</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">downloads</span> <span class="op">~</span> </span>
<span>        <span class="va">ever_treated</span><span class="op">:</span><span class="va">post_1</span> <span class="op">+</span></span>
<span>        <span class="va">ever_treated</span><span class="op">:</span><span class="va">post_2</span> <span class="op">+</span></span>
<span>        <span class="va">ever_treated</span><span class="op">:</span><span class="va">post_3</span> <span class="op">+</span></span>
<span>        <span class="va">ever_treated</span><span class="op">:</span><span class="va">post_4</span> <span class="op">+</span></span>
<span>        <span class="va">ever_treated</span><span class="op">:</span><span class="va">post_5</span> <span class="op">+</span></span>
<span>        <span class="va">ever_treated</span><span class="op">:</span><span class="va">post_6</span> <span class="op">+</span></span>
<span>        <span class="va">ever_treated</span><span class="op">:</span><span class="va">post_7</span> <span class="op">+</span></span>
<span>        <span class="co">#ever_treated:post_8 + reference value</span></span>
<span>        <span class="va">ever_treated</span><span class="op">:</span><span class="va">post</span> <span class="op">|</span> <span class="va">city</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">df_placebo_all</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: downloads
Observations: 1,800
Fixed-effects: city: 200,  month: 9
Standard-errors: Clustered (city) 
                    Estimate Std. Error t value   Pr(&gt;|t|)    
ever_treated:post_1     19.1        6.3    3.03 2.7416e-03 ** 
ever_treated:post_2     16.8        5.5    3.03 2.7654e-03 ** 
ever_treated:post_3     17.4        4.8    3.64 3.4584e-04 ***
ever_treated:post_4     10.0        4.1    2.42 1.6456e-02 *  
ever_treated:post_5      5.7        3.8    1.51 1.3288e-01    
ever_treated:post_6      3.0        3.2    0.93 3.5104e-01    
ever_treated:post_7      2.0        2.9    0.68 4.9679e-01    
ever_treated:post       14.9        3.0    4.97 1.4628e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 19.6     Adj. R2: 0.967926
             Within R2: 0.030489</code></pre>
</div>
</div>
<p>An even more programmatic way to test for pre-trends is to run an event study to perform the tests all in one command. We only have to slightly change the input. Instead of the single treatment indicator <code>ever_treated:post</code>, which is only active for the treated group after treatment, we include several interactions which cover all periods for the treated group.</p>
<p>We can do so with the help of <code><a href="https://lrberge.github.io/fixest/reference/i.html">i()</a></code> from the <code>fixest</code> package and a newly created variable that measures the time distance to the treatment period.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create time distance column</span></span>
<span><span class="va">treat_month</span> <span class="op">&lt;-</span> <span class="fl">9</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time_to_treat <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ever_treated</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">month</span> <span class="op">-</span> <span class="va">treat_month</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">evt_stdy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">downloads</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">time_to_treat</span>, <span class="va">ever_treated</span>, ref <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">|</span> <span class="va">city</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">evt_stdy</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: downloads
Observations: 1,800
Fixed-effects: city: 200,  month: 9
Standard-errors: Clustered (city) 
                               Estimate Std. Error t value   Pr(&gt;|t|)    
time_to_treat::-8:ever_treated     19.1        6.3    3.03 2.7416e-03 ** 
time_to_treat::-7:ever_treated     16.8        5.5    3.03 2.7654e-03 ** 
time_to_treat::-6:ever_treated     17.4        4.8    3.64 3.4584e-04 ***
time_to_treat::-5:ever_treated     10.0        4.1    2.42 1.6456e-02 *  
time_to_treat::-4:ever_treated      5.7        3.8    1.51 1.3288e-01    
time_to_treat::-3:ever_treated      3.0        3.2    0.93 3.5104e-01    
time_to_treat::-2:ever_treated      2.0        2.9    0.68 4.9679e-01    
time_to_treat::0:ever_treated      14.9        3.0    4.97 1.4628e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 19.6     Adj. R2: 0.967926
             Within R2: 0.030489</code></pre>
</div>
</div>
<p>Using <code><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot()</a></code> we can visualize the multiple treatment effects. Any treatment effect prior to the treatment is a big cause of concern with regards to the parallel trends assumption.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot event study</span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">evt_stdy</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_9_files/figure-html/unnamed-chunk-17-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="week_9_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="conditional-parallel-trends" class="level2"><h2 class="anchored" data-anchor-id="conditional-parallel-trends">Conditional parallel trends</h2>
<p>Now, we have seen that we cannot assume parallel trends - there are significant differences in the evolution of outcomes. But what can we do to increase the plausibility of assuming parallel trends? One approach that is widely been used in practice is the inclusion of covariates. But as you have learned in the lecture, you have to be extremely careful.</p>
<p>What you obtain then is the conditional parallel trends assumption, which is the assumption of parallel trends conditional on covariates.</p>
<p><span class="math display">\[
\mathbb{E}[Y_{i,t=1}(0) - Y_{i,t=0}(0) | T_i=1, \mathbf{X_i}] = \mathbb{E}[Y_{i,t=1}(0) - Y_{i,t=0}(0) | T_i=0, \mathbf{X_i}] \quad
\]</span></p>
<p><span style="color:#FF7E15"><strong>Task 5:</strong></span> Include the covariates into the event study and consider that they have time-varying effects.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Time-invariant, therefore multicollinearity.</span></span>
<span><span class="va">evt_stdy_cond_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>  <span class="va">downloads</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">time_to_treat</span>, <span class="va">ever_treated</span>, ref <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">age</span> <span class="op">+</span> <span class="va">user_share</span> <span class="op">+</span> <span class="va">population_size</span> <span class="op">+</span> <span class="va">competitor_price</span></span>
<span>  <span class="op">|</span> <span class="va">city</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>The variables 'age', 'user_share', 'population_size' and 'competitor_price' have been removed because of collinearity (see $collin.var).</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">evt_stdy_cond_1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: downloads
Observations: 1,800
Fixed-effects: city: 200,  month: 9
Standard-errors: Clustered (city) 
                               Estimate Std. Error t value   Pr(&gt;|t|)    
time_to_treat::-8:ever_treated     19.1        6.3    3.03 2.7416e-03 ** 
time_to_treat::-7:ever_treated     16.8        5.5    3.03 2.7654e-03 ** 
time_to_treat::-6:ever_treated     17.4        4.8    3.64 3.4584e-04 ***
time_to_treat::-5:ever_treated     10.0        4.1    2.42 1.6456e-02 *  
time_to_treat::-4:ever_treated      5.7        3.8    1.51 1.3288e-01    
time_to_treat::-3:ever_treated      3.0        3.2    0.93 3.5104e-01    
time_to_treat::-2:ever_treated      2.0        2.9    0.68 4.9679e-01    
time_to_treat::0:ever_treated      14.9        3.0    4.97 1.4628e-06 ***
... 4 variables were removed because of collinearity (age, user_share and 2 others [full set in $collin.var])
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 19.6     Adj. R2: 0.967926
             Within R2: 0.030489</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Time-invariant, but time-varying effects.</span></span>
<span><span class="va">evt_stdy_cond_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span></span>
<span>  <span class="va">downloads</span> <span class="op">~</span> <span class="fu"><a href="https://lrberge.github.io/fixest/reference/i.html">i</a></span><span class="op">(</span><span class="va">time_to_treat</span>, <span class="va">ever_treated</span>, ref <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">age</span><span class="op">:</span><span class="va">month</span> <span class="op">+</span> <span class="va">user_share</span><span class="op">:</span><span class="va">month</span> <span class="op">+</span> <span class="va">population_size</span><span class="op">:</span><span class="va">month</span> <span class="op">+</span> <span class="va">competitor_price</span><span class="op">:</span> <span class="va">month</span></span>
<span>  <span class="op">|</span> <span class="va">city</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span><span class="va">evt_stdy_cond_2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: downloads
Observations: 1,800
Fixed-effects: city: 200,  month: 9
Standard-errors: Clustered (city) 
                               Estimate Std. Error t value   Pr(&gt;|t|)    
time_to_treat::-8:ever_treated    -3.11      3.339   -0.93 3.5244e-01    
time_to_treat::-7:ever_treated    -2.24      3.364   -0.67 5.0676e-01    
time_to_treat::-6:ever_treated     1.58      3.271    0.48 6.3003e-01    
time_to_treat::-5:ever_treated    -2.66      3.071   -0.87 3.8768e-01    
time_to_treat::-4:ever_treated    -3.79      3.115   -1.22 2.2503e-01    
time_to_treat::-3:ever_treated    -3.36      2.851   -1.18 2.3982e-01    
time_to_treat::-2:ever_treated    -1.17      2.827   -0.41 6.8065e-01    
time_to_treat::0:ever_treated     18.03      2.870    6.28 2.0508e-09 ***
age:month                          3.47      0.300   11.57  &lt; 2.2e-16 ***
month:user_share                  49.36      5.315    9.29  &lt; 2.2e-16 ***
month:population_size              0.32      0.048    6.60 3.6438e-10 ***
month:competitor_price             2.22      0.430    5.16 5.9256e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 14.1     Adj. R2: 0.983262
             Within R2: 0.495338</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot event study</span></span>
<span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/coefplot.html">iplot</a></span><span class="op">(</span><span class="va">evt_stdy_cond_2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_9_files/figure-html/unnamed-chunk-21-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="week_9_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="att-conditional-on-covariates" class="level2"><h2 class="anchored" data-anchor-id="att-conditional-on-covariates">ATT conditional on covariates</h2>
<section id="twfe" class="level3"><h3 class="anchored" data-anchor-id="twfe">TWFE</h3>
<p><span style="color:#FF7E15"><strong>Task 6:</strong></span> Use the TWFE approach to estimate the ATT by under the assumption of parallel trend conditional on the covariates.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://lrberge.github.io/fixest/reference/feols.html">feols</a></span><span class="op">(</span><span class="va">downloads</span> <span class="op">~</span> <span class="va">post</span><span class="op">:</span><span class="va">ever_treated</span> <span class="op">+</span></span>
<span>                    <span class="va">age</span><span class="op">:</span><span class="va">month</span> <span class="op">+</span> <span class="va">user_share</span><span class="op">:</span><span class="va">month</span> <span class="op">+</span> <span class="va">population_size</span><span class="op">:</span><span class="va">month</span> <span class="op">+</span> <span class="va">competitor_price</span><span class="op">:</span> <span class="va">month</span></span>
<span>                  <span class="op">|</span> <span class="va">city</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>OLS estimation, Dep. Var.: downloads
Observations: 1,800
Fixed-effects: city: 200,  month: 9
Standard-errors: Clustered (city) 
                       Estimate Std. Error t value   Pr(&gt;|t|)    
post:ever_treated         19.80      2.525     7.8 2.6261e-13 ***
age:month                  3.46      0.296    11.7  &lt; 2.2e-16 ***
month:user_share          49.49      5.244     9.4  &lt; 2.2e-16 ***
month:population_size      0.32      0.048     6.6 4.5016e-10 ***
month:competitor_price     2.21      0.428     5.1 6.2757e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 14.2     Adj. R2: 0.983281
             Within R2: 0.49367 </code></pre>
</div>
</div>
</section><section id="doubly-robust-estimator" class="level3"><h3 class="anchored" data-anchor-id="doubly-robust-estimator">Doubly robust estimator</h3>
<p>During the last weeks we have already learned the advantages of doubly robust estimation and in fact, there is a doubly robust DiD estimator proposed by <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304407620301901">Sant’Anna and Zhao, 2020</a> and implemented in the <code>DRDID</code> package.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"DRDID"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://psantanna.com/DRDID/">DRDID</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://psantanna.com/DRDID/reference/drdid.html">drdid</a></span><span class="op">(</span></span>
<span>  yname <span class="op">=</span> <span class="st">"downloads"</span>,</span>
<span>  tname <span class="op">=</span> <span class="st">"post"</span>,</span>
<span>  idname <span class="op">=</span> <span class="st">"city"</span>,</span>
<span>  dname <span class="op">=</span> <span class="st">"ever_treated"</span>,</span>
<span>  xformla <span class="op">=</span> <span class="op">~</span><span class="va">age</span><span class="op">+</span><span class="va">user_share</span><span class="op">+</span><span class="va">population_size</span><span class="op">+</span><span class="va">competitor_price</span>,</span>
<span>  data <span class="op">=</span> <span class="va">df_2p</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Call:
drdid(yname = "downloads", tname = "post", idname = "city", dname = "ever_treated", 
    xformla = ~age + user_share + population_size + competitor_price, 
    data = df_2p)
------------------------------------------------------------------
 Further improved locally efficient DR DID estimator for the ATT:
 
   ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] 
 18.6812     3.2087     5.822        0       12.3922    24.9703  
------------------------------------------------------------------
 Estimator based on panel data.
 Outcome regression est. method: weighted least squares.
 Propensity score est. method: inverse prob. tilting.
 Analytical standard error.
------------------------------------------------------------------
 See Sant'Anna and Zhao (2020) for details.</code></pre>
</div>
</div>
<p><span style="color:#FF7E15"><strong>Task 7:</strong></span> Following the same syntax, use the outcome regression adjustment with <code><a href="https://psantanna.com/DRDID/reference/ordid.html">ordid()</a></code> and the inverse probability weighting approach <code><a href="https://psantanna.com/DRDID/reference/ipwdid.html">ipwdid()</a></code> to estimate the treatment effect.</p>
</section><section id="outcome-regression" class="level3"><h3 class="anchored" data-anchor-id="outcome-regression">Outcome regression</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://psantanna.com/DRDID/reference/ordid.html">ordid</a></span><span class="op">(</span></span>
<span>  yname <span class="op">=</span> <span class="st">"downloads"</span>,</span>
<span>  tname <span class="op">=</span> <span class="st">"post"</span>,</span>
<span>  idname <span class="op">=</span> <span class="st">"city"</span>,</span>
<span>  dname <span class="op">=</span> <span class="st">"ever_treated"</span>,</span>
<span>  xformla <span class="op">=</span> <span class="op">~</span><span class="va">age</span><span class="op">+</span><span class="va">user_share</span><span class="op">+</span><span class="va">population_size</span><span class="op">+</span><span class="va">competitor_price</span>,</span>
<span>  data <span class="op">=</span> <span class="va">df_2p</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code> Call:
ordid(yname = "downloads", tname = "post", idname = "city", dname = "ever_treated", 
    xformla = ~age + user_share + population_size + competitor_price, 
    data = df_2p)
------------------------------------------------------------------
 Outcome-Regression DID estimator for the ATT:
 
   ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] 
 19.2478     3.2017     6.0117       0       12.9724    25.5232  
------------------------------------------------------------------
 Estimator based on panel data.
 Outcome regression est. method: OLS.
 Analytical standard error.
------------------------------------------------------------------
 See Sant'Anna and Zhao (2020) for details.</code></pre>
</div>
</div>
</section><section id="inverse-probability-weighting-regression" class="level3"><h3 class="anchored" data-anchor-id="inverse-probability-weighting-regression">Inverse probability weighting regression</h3>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://psantanna.com/DRDID/reference/ipwdid.html">ipwdid</a></span><span class="op">(</span></span>
<span>  yname <span class="op">=</span> <span class="st">"downloads"</span>,</span>
<span>  tname <span class="op">=</span> <span class="st">"post"</span>,</span>
<span>  idname <span class="op">=</span> <span class="st">"city"</span>,</span>
<span>  dname <span class="op">=</span> <span class="st">"ever_treated"</span>,</span>
<span>  xformla <span class="op">=</span> <span class="op">~</span><span class="va">age</span><span class="op">+</span><span class="va">user_share</span><span class="op">+</span><span class="va">population_size</span><span class="op">+</span><span class="va">competitor_price</span>,</span>
<span>  data <span class="op">=</span> <span class="va">df_2p</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code> Call:
ipwdid(yname = "downloads", tname = "post", idname = "city", 
    dname = "ever_treated", xformla = ~age + user_share + population_size + 
        competitor_price, data = df_2p)
------------------------------------------------------------------
 IPW DID estimator for the ATT:
 
   ATT     Std. Error  t value    Pr(&gt;|t|)  [95% Conf. Interval] 
 18.7472     3.3073     5.6684       0       12.2648    25.2296  
------------------------------------------------------------------
 Estimator based on panel data.
 Hajek-type IPW estimator (weights sum up to 1).
 Propensity score est. method: maximum likelihood.
 Analytical standard error.
------------------------------------------------------------------
 See Sant'Anna and Zhao (2020) for details.</code></pre>
</div>
</div>
</section></section><section id="assignment" class="level2"><h2 class="anchored" data-anchor-id="assignment">Assignment</h2>
<p>Accept the <a href="https://classroom.github.com/a/TvLAqy53">Week 9 - Assignment</a> and follow the same steps as last week and as described in the organization chapter.</p>
<p>Please also remember to fill out the <a href="https://evaluating.tuhh.de/evasys/online.php?pswd=597RW">course evaluation</a> if you have not done so already.</p>
<div class="assignment">
<ol type="1">
<li><p>Explain under what circumstances a time-invariant covariate can be a confounder.</p></li>
<li><p>Explain under what circumstances a time-varying covariate can be a confounder.</p></li>
<li><p>Let’s consider the variable <code>competitor_price</code> was time-variant and for each period, we would observe the price in the same period set by the competitor. Do you see any risk in using this variable?</p></li>
<li><p>Apply the doubly robust estimator with ML from the lecture to the data from the tutorial. Use the models <code>"regr.xgboost"</code> and <code>"classif.xgboost"</code>. Additionally, implement cross-fitting (K=5). Report and compare the result to the other estimates.</p></li>
<li><p>Check what happens when you simulate a misspecification of the outcome model by replacing <code>delta_mu</code> with <code>sample(delta_mu, replace = FALSE)</code> or a misspecification of the exposure model by replacing <code>ehat</code> with <code>sample(ehat, replace = FALSE)</code>. Report and discuss your result.</p></li>
</ol>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../../content/course_weeks/week_08/week_8.html" class="pagination-link  aria-label=" recap="" from="" week="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">8 - Recap from week 5, 6, 7</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../content/course_weeks/week_10/week_10.html" class="pagination-link" aria-label="10 - Difference-in-Differences (2/2)">
        <span class="nav-page-text">10 - Difference-in-Differences (2/2)</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>lv3095_s24: Causal Data Science for Business Analytics</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"selector":".lightbox","closeEffect":"zoom","loop":false,"openEffect":"zoom","descPosition":"bottom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>


</body></html>