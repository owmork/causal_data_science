<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.536">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>CAUSAL DATA SCIENCE FOR BUSINESS ANALYTICS - 6 - Effect Heterogeneity</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../content/course_weeks/week_07/week_7.html" rel="next">
<link href="../../../content/course_weeks/week_05/week_5.html" rel="prev">
<link href="../../../images/favicon_cds_16x16.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script src="../../../site_libs/quarto-contrib/iconify-1.0.7/iconify-icon.min.js"></script>
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="../../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../../site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script><link rel="stylesheet" href="../../../styles.css">
</head>
<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../images/icon_cds.svg" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title"><b>CAUSAL DATA SCIENCE FOR BUSINESS ANALYTICS</b></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../../content/course_weeks/overview.html" aria-current="page"> 
<span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../content/organization/mattermost.html"> 
<span class="menu-text">Organization</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://communicating.tuhh.de/w-11-students/channels/cdsba_ss24"> 
<span class="menu-text"><iconify-icon inline="" icon="cib:mattermost" style="font-size: 1.25em;"></iconify-icon></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../content/course_weeks/week_01/week_1.html"><b>Weekly content</b></a></li><li class="breadcrumb-item"><a href="../../../content/course_weeks/week_06/week_6.html">6 - Effect Heterogeneity</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text"><b>Weekly content</b></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_01/week_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1 - Introduction to Causal Inference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_02/week_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2 - Graphical Causal Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_03/week_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3 - Randomized Experiments &amp; Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_04/week_4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4 - Matching</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_05/week_5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5 - Double Machine Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_06/week_6.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">6 - Effect Heterogeneity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_07/week_7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">7 - Unobserved Confounding &amp; Instrumental Variables</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_08/week_8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">8 - Difference-in-Difference</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_09/week_9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">9 - Synthetic Control</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_10/week_10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10 - Regression Discontinuity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/course_weeks/week_11/week_11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11 - Causal Mediation</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text"><b>Optional reads</b></span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/optional_read/motivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motivation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/optional_read/prob.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Probability Theory</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../content/optional_read/stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical Concepts</span></a>
  </div>
</li>
      </ul>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#slides-recap" id="toc-slides-recap" class="nav-link active" data-scroll-target="#slides-recap">Slides &amp; Recap</a></li>
  <li>
<a href="#metalearners" id="toc-metalearners" class="nav-link" data-scroll-target="#metalearners">Metalearners</a>
  <ul class="collapse">
<li><a href="#r-learner" id="toc-r-learner" class="nav-link" data-scroll-target="#r-learner">R-learner</a></li>
  <li><a href="#dr-learner" id="toc-dr-learner" class="nav-link" data-scroll-target="#dr-learner">DR-learner</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul>
</li>
  <li>
<a href="#evaluation-of-effect-heterogeneity" id="toc-evaluation-of-effect-heterogeneity" class="nav-link" data-scroll-target="#evaluation-of-effect-heterogeneity">Evaluation of effect heterogeneity</a>
  <ul class="collapse">
<li><a href="#best-linear-predictor" id="toc-best-linear-predictor" class="nav-link" data-scroll-target="#best-linear-predictor">Best linear predictor</a></li>
  <li><a href="#sorted-group-average-treatment-effects" id="toc-sorted-group-average-treatment-effects" class="nav-link" data-scroll-target="#sorted-group-average-treatment-effects">Sorted group average treatment effects</a></li>
  <li><a href="#classification-analysis" id="toc-classification-analysis" class="nav-link" data-scroll-target="#classification-analysis">Classification analysis</a></li>
  </ul>
</li>
  <li><a href="#assignment" id="toc-assignment" class="nav-link" data-scroll-target="#assignment">Assignment</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../content/course_weeks/week_01/week_1.html"><b>Weekly content</b></a></li><li class="breadcrumb-item"><a href="../../../content/course_weeks/week_06/week_6.html">6 - Effect Heterogeneity</a></li></ol></nav><div class="quarto-title">
<h1 class="title">6 - Effect Heterogeneity</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="slides-recap" class="level2"><h2 class="anchored" data-anchor-id="slides-recap">Slides &amp; Recap</h2>
<iframe style="width: 100%; height: 45vw; max-height: 50vh;" frameborder="0" allowfullscreen="" src="https://tuhhstartupengineers-classroom.github.io/ss24-causal-data-science/slides/06_hte.html">
</iframe>
<p>Up until now, we have primarily discussed the general impact of a treatment. Let’s shift our focus to how treatments can affect different units in various ways. This involves the concept of personalized treatment effects and the improved assignment of treatments, especially in situations where it’s not feasible to treat everyone and prioritization is necessary. This topic is closely related to predictive problems, cross-validation, and model selection, with effect validation being more challenging than for a simple predictive model.</p>
<p>In recent weeks, we have occasionally estimated Conditional Average Treatment Effects (CATE) by manually assuming group-level heterogeneity.</p>
<p><span class="math display">\[
\tau(\mathbf{x}) = \mathbb{E}[Y_i(1) - Y_i(0) | \mathbf{X_i = x}]
\]</span></p>
</section><section id="metalearners" class="level2"><h2 class="anchored" data-anchor-id="metalearners">Metalearners</h2>
<p>Now predict individualized treatment effects based on all covariates <span class="math inline">\(X_i\)</span> under the assumption of observed confounding using metalearners.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>No proper cross-fitting</strong></p>
<p>In the next steps, you are going to code the metalearners by hand. For simplicity, you don’t need to perform proper cross-fitting because the focus is on understanding the mechanisms of metalearners.</p>
</div>
</div>
<p>We will focus on the R-learner and the DR-learner, which have the advantage of minimizing only one loss function. However, there are also other types of metalearners, such as the S-learner, T-learner, and X-learner.</p>
<p>In general, metalearners combine multiple supervised machine learning steps into a pipeline that outputs predicted Conditional Average Treatment Effects (CATEs). The typical process involves:</p>
<ol type="1">
<li>Estimating nuisance parameters.</li>
<li>Plugging these estimates into a minimization problem targeting CATE.</li>
<li>Solving the minimization problem.</li>
<li>Using the model learned in step 3 to predict CATE.</li>
</ol>
<section id="r-learner" class="level3"><h3 class="anchored" data-anchor-id="r-learner">R-learner</h3>
<p>A robust and flexible approach to estimating heterogeneous treatment effects is the R-learner, which we will now examine. We will explore two specifications: the partially linear R-learner and the generic machine learning (ML) R-learner.</p>
<section id="partially-linear-r-learner" class="level4"><h4 class="anchored" data-anchor-id="partially-linear-r-learner">Partially linear R-learner</h4>
<p>Related to the FWL theorem and the double machine learning with partially linear regression, which we discussed last time, the R-learner slightly adjusts the minimization problem by allowing the treatment effects to vary with the covariates <span class="math inline">\(mathbf{X}\)</span>.</p>
<p><span class="math display">\[
\underbrace{Y_i - \overbrace{\mathbb{E}[Y_i \mid \mathbf{X_i}]}^{\mu(\mathbf{X_i})}}_{\text{outcome residual}} = \tau(\mathbf{X_i}) \underbrace{( T_i - \overbrace{\mathbb{E}[T_i \mid \mathbf{X_i}]}^{e(\mathbf{X_i})})}_{\text{treatment residual}} + \epsilon_{Y_i}
\]</span> The minimization problem is the same except for the potentially heterogeneous treatment effect <span class="math inline">\(\tau(\mathbf{X_i})\)</span> instead of the homogeneous treatment effect <span class="math inline">\(\tau)\)</span>.</p>
<p><span class="math display">\[
\hat{\tau}_{\text{RL}}(\mathbf{x}) = \arg \min_{\tau} \sum_{i=1}^n ( Y_i - \hat{\mu}(\mathbf{X_i}) - \tau(\mathbf{X_i}) ( T_i - \hat{e}(\mathbf{X_i})))^2
\]</span> With some modifications, we can see that by using a modified covariate <span class="math inline">\(\mathbf{X_i}\)</span>, we can estimate with a linear model that minimize squares and solves the minimization problem in the final step.</p>
<p><span class="math display">\[
\begin{align*}
\hat{\beta}_{RL} &amp;= \underset{\beta}{\operatorname{arg\,min}} \sum_{i=1}^N( Y_i - \hat{\mu}(\mathbf{X_i}) - \mathbf{\beta'} \underbrace{(T_i - \hat{e}(\mathbf{X_i})) \mathbf{X_i}}_{=\mathbf{\tilde{X}_i}})^2 \\
&amp;= \underset{\beta}{\operatorname{arg\,min}} \sum_{i=1}^N \left( Y_i - \hat{\mu}(\mathbf{X_i}) - \mathbf{\beta'} \mathbf{\tilde{X}_i} \right)^2
\end{align*}
\]</span> For estimating the outcome model <span class="math inline">\(\hat{\mu}(\mathbf{X_i})\)</span> and the exposure model <span class="math inline">\(\hat{e}(\mathbf{X_i})\)</span>, we can use well suited ML functions.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Of course, there are packages and functions to just specify your data, treatment, outcome and covariates and you’ll get the result. But to better understand what’s going on under the hood, we are going to perform it manually here.</p>
</div>
</div>
<p><em>Imagine the following situation. You are operating an online shop, and a year ago, introduced a plus membership aimed at binding customers and driving revenue growth. The plus memberships comes at a small cost for the customers, which is why not all of the customers subscribed. Now you want to examine whether binding customers by this membership program in fact increases your sales with subscribed customers. However, it’s essential to consider potential confounding variables such as age, gender, or previous average purchase amounts. And this time you also measure a bunch of other variables which might let ML methods be more advantageous due to their way of handling high-dimensional data.</em></p>
<p>Each row in your <a href="https://cloud.tuhh.de/index.php/s/N85C6xAerg7SaE9">dataset</a> corresponds to a different customer, with accompanying demographic details, their average purchase sum before the introduction of the plus membership, their current average purchase, an indication of their participation in the plus membership program, and the categories they have bought in.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">membership</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"membership.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="va">membership</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,000
Columns: 27
$ age                &lt;dbl&gt; 32, 42, 23, 67, 27, 54, 40, 27, 29, 35, 22, 37, 25, 41, 37, 60, 32, 31, 30, 41, 34, 48, 42, 41, 38, 29, 37, 27, 26, 27, 5…
$ sex                &lt;int&gt; 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0…
$ pre_avg_purch      &lt;dbl&gt; 22, 32, 32, 47, 30, 31, 38, 26, 26, 47, 36, 55, 32, 26, 48, 41, 23, 23, 33, 30, 31, 25, 43, 37, 22, 40, 33, 24, 23, 37, 3…
$ card               &lt;int&gt; 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1…
$ avg_purch          &lt;dbl&gt; 45.45, 72.73, 64.20, 55.66, 80.08, 35.34, 10.22, 45.32, 0.56, 69.84, 53.71, 55.46, 53.50, 44.00, 29.72, 33.08, 32.08, 37.…
$ vehicle            &lt;int&gt; 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ food               &lt;int&gt; 1, 2, 0, 1, 1, 0, 1, 0, 0, 0, 2, 0, 1, 2, 1, 0, 0, 1, 1, 2, 1, 2, 4, 1, 0, 2, 2, 0, 0, 2, 1, 2, 2, 2, 2, 2, 1, 0, 1, 1, 1…
$ beverage           &lt;int&gt; 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 1, 2, 1, 0, 3, 0, 0, 1, 0, 1, 4, 0, 2, 3, 1, 1, 2, 2, 1, 1, 1, 1, 2, 0, 1, 1, 0, 2, 1, 0…
$ art                &lt;int&gt; 0, 2, 1, 2, 1, 0, 0, 1, 1, 1, 3, 0, 0, 3, 1, 3, 1, 0, 0, 0, 2, 1, 2, 1, 1, 1, 1, 0, 1, 2, 3, 0, 2, 0, 2, 0, 1, 0, 1, 2, 0…
$ baby               &lt;int&gt; 1, 1, 1, 1, 1, 1, 2, 1, 3, 1, 2, 0, 1, 2, 0, 0, 0, 2, 0, 0, 0, 1, 0, 1, 2, 2, 3, 1, 1, 0, 1, 2, 0, 2, 0, 0, 2, 2, 0, 1, 1…
$ personal_care      &lt;int&gt; 0, 0, 2, 1, 1, 1, 3, 1, 1, 0, 1, 1, 0, 0, 1, 0, 2, 0, 1, 1, 0, 1, 2, 1, 0, 2, 0, 0, 3, 2, 1, 1, 1, 2, 0, 1, 0, 3, 1, 2, 1…
$ toys               &lt;int&gt; 0, 0, 3, 2, 1, 1, 1, 2, 2, 0, 0, 1, 2, 3, 0, 1, 1, 0, 1, 2, 1, 0, 1, 0, 1, 0, 0, 0, 2, 0, 1, 2, 3, 0, 1, 0, 1, 1, 1, 1, 1…
$ clothing           &lt;int&gt; 2, 1, 2, 2, 2, 1, 1, 2, 2, 2, 5, 1, 1, 1, 1, 3, 0, 1, 2, 2, 5, 2, 3, 1, 2, 1, 1, 0, 0, 1, 0, 0, 2, 5, 1, 0, 3, 1, 1, 2, 1…
$ decor              &lt;int&gt; 0, 0, 0, 3, 2, 2, 0, 1, 1, 0, 2, 0, 0, 2, 1, 1, 0, 1, 0, 2, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 3, 1, 2, 2, 2, 0, 0, 1, 1, 2…
$ cell_phones        &lt;int&gt; 1, 2, 4, 1, 1, 2, 4, 4, 3, 1, 5, 1, 3, 2, 3, 4, 3, 3, 1, 4, 3, 5, 2, 4, 5, 5, 5, 4, 2, 4, 2, 2, 2, 3, 5, 3, 3, 2, 3, 4, 1…
$ construction       &lt;int&gt; 1, 2, 1, 1, 1, 4, 1, 0, 3, 0, 0, 0, 2, 1, 0, 0, 2, 0, 0, 0, 1, 2, 1, 2, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 3, 1, 2, 1, 1, 3…
$ home_appliances    &lt;int&gt; 0, 2, 0, 1, 1, 0, 1, 0, 0, 2, 1, 0, 0, 0, 2, 0, 1, 1, 1, 2, 0, 1, 0, 1, 1, 0, 2, 0, 3, 0, 1, 4, 1, 1, 1, 0, 1, 2, 1, 2, 2…
$ electronics        &lt;int&gt; 1, 2, 4, 0, 2, 2, 1, 2, 2, 3, 1, 3, 3, 0, 4, 1, 2, 1, 2, 2, 2, 0, 2, 2, 0, 2, 4, 0, 0, 2, 4, 2, 2, 1, 0, 2, 1, 1, 0, 3, 2…
$ sports             &lt;int&gt; 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 2, 4, 0, 2, 0, 3, 2, 0, 1, 0, 1, 2, 3, 4, 0, 2, 1, 1, 0, 1, 0, 1, 2…
$ tools              &lt;int&gt; 3, 2, 1, 1, 1, 2, 1, 0, 4, 2, 1, 0, 0, 2, 0, 1, 1, 2, 2, 0, 0, 1, 1, 0, 0, 0, 0, 2, 1, 0, 1, 0, 3, 0, 0, 1, 0, 2, 1, 0, 0…
$ games              &lt;int&gt; 4, 1, 3, 1, 2, 1, 3, 1, 0, 3, 0, 1, 1, 7, 1, 3, 0, 1, 2, 3, 0, 2, 2, 1, 2, 6, 3, 1, 2, 1, 0, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2…
$ industry           &lt;int&gt; 0, 0, 2, 0, 0, 1, 0, 0, 3, 2, 1, 2, 1, 0, 0, 2, 1, 0, 3, 0, 0, 0, 3, 1, 3, 0, 1, 3, 2, 0, 2, 0, 2, 1, 1, 0, 0, 2, 0, 2, 1…
$ pc                 &lt;int&gt; 4, 2, 2, 2, 3, 0, 2, 1, 3, 0, 3, 2, 3, 3, 2, 1, 0, 0, 3, 2, 3, 2, 1, 1, 3, 1, 3, 2, 2, 0, 2, 4, 2, 1, 0, 0, 4, 2, 3, 2, 0…
$ jewel              &lt;int&gt; 0, 1, 0, 0, 0, 2, 0, 0, 0, 4, 1, 0, 0, 1, 3, 1, 0, 3, 1, 4, 0, 1, 2, 0, 1, 2, 2, 2, 2, 0, 1, 1, 0, 2, 0, 0, 1, 4, 0, 1, 1…
$ books              &lt;int&gt; 2, 1, 0, 0, 1, 0, 0, 0, 4, 2, 1, 2, 1, 2, 0, 1, 0, 0, 0, 3, 0, 3, 1, 2, 2, 2, 2, 1, 0, 1, 2, 1, 1, 1, 1, 0, 0, 3, 0, 2, 1…
$ music_books_movies &lt;int&gt; 1, 3, 3, 2, 2, 1, 1, 0, 2, 2, 0, 0, 2, 3, 2, 0, 1, 0, 2, 1, 0, 1, 2, 1, 1, 0, 0, 1, 2, 0, 1, 0, 2, 0, 2, 1, 2, 0, 1, 0, 0…
$ health             &lt;int&gt; 0, 0, 2, 2, 6, 0, 4, 2, 2, 2, 2, 0, 3, 1, 0, 2, 3, 2, 1, 3, 4, 2, 3, 1, 2, 1, 5, 3, 2, 2, 5, 1, 5, 2, 1, 0, 0, 4, 5, 4, 3…</code></pre>
</div>
</div>
<p>Again, we are going to rely on the <code>mlr3</code> packages for ML models.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com">mlr3learners</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the first step, we train the models for the nuisance parameters <span class="math inline">\(\hat{\mu}(\mathbf{X_i})\)</span> and <span class="math inline">\(\hat{e}(\mathbf{X_i})\)</span>.</p>
<p><strong>Q1: Specify the nuisance models. Then, train and predict to obtain the residuals.</strong></p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Specify</span></span>
<span><span class="co"># Prediction model for the treatment/exposure</span></span>
<span><span class="va">task_e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_classif.html">as_task_classif</a></span><span class="op">(</span><span class="va">membership</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">avg_purch</span><span class="op">)</span>, target <span class="op">=</span> <span class="st">"card"</span><span class="op">)</span></span>
<span><span class="va">lrnr_e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"classif.log_reg"</span>, predict_type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prediction model for the outcome</span></span>
<span><span class="va">task_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_regr.html">as_task_regr</a></span><span class="op">(</span><span class="va">membership</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">card</span><span class="op">)</span>, target <span class="op">=</span> <span class="st">"avg_purch"</span><span class="op">)</span></span>
<span><span class="va">lrnr_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.lm"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Train</span></span>
<span><span class="va">lrnr_m</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_m</span><span class="op">)</span></span>
<span><span class="va">lrnr_e</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_e</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Predict</span></span>
<span><span class="va">m_pred_tbl</span> <span class="op">&lt;-</span> <span class="va">lrnr_m</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task_m</span><span class="op">)</span></span>
<span><span class="va">e_pred_tbl</span> <span class="op">&lt;-</span> <span class="va">lrnr_e</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task_e</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Residualize</span></span>
<span><span class="co"># True values</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="va">membership</span><span class="op">$</span><span class="va">card</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">membership</span><span class="op">$</span><span class="va">avg_purch</span></span>
<span></span>
<span><span class="co"># Residuals</span></span>
<span><span class="va">Y_res</span> <span class="op">&lt;-</span> <span class="va">Y</span> <span class="op">-</span> <span class="va">m_pred_tbl</span><span class="op">$</span><span class="va">response</span></span>
<span><span class="va">D_res</span> <span class="op">&lt;-</span> <span class="va">D</span> <span class="op">-</span> <span class="va">e_pred_tbl</span><span class="op">$</span><span class="va">prob</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, you can construct the modified covariates as obtained in the minimization problem.</p>
<p><span class="math display">\[
\mathbf{\tilde{X}_i} = (T_i - \hat{e}(\mathbf{X_i})) \mathbf{X_i}
\]</span> Please note, that you also have to include the intercept column with all values equal to 1, e.g.&nbsp;by using <code>rep(1, n)</code> or <code>mutate(intercept = 1)</code>.</p>
<p><strong>Q2: Construct a data frame or matrix that contains the modified covariates and the intercept.</strong></p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get matrix of unmodified covariates</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">membership</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">avg_purch</span>, <span class="op">-</span><span class="va">card</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Modify by multiplying with residuals</span></span>
<span><span class="va">X_tilde</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op">*</span> <span class="va">D_res</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now, you need to solve the minimization problem. Since we are focusing on a linear model, you can use the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function. Alternatively, you can apply linear shrinkage estimators, such as Lasso.</p>
<p><strong>Q3: Run a regression of the residualized outcome on the modified covariates and report the results.</strong></p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Partially linear R-Learner</span></span>
<span><span class="va">rl_pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y_res</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">X_tilde</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rl_pl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = Y_res ~ 0 + X_tilde)

Residuals:
   Min     1Q Median     3Q    Max 
-46.41 -10.92   0.22  10.49  39.31 

Coefficients:
                          Estimate Std. Error t value Pr(&gt;|t|)    
X_tildeage                 -1.1424     0.0842  -13.56  &lt; 2e-16 ***
X_tildesex                  6.6572     1.9958    3.34  0.00088 ***
X_tildepre_avg_purch       -0.1253     0.1014   -1.24  0.21698    
X_tildevehicle              0.5023     3.2101    0.16  0.87568    
X_tildefood                -0.5471     1.0029   -0.55  0.58550    
X_tildebeverage            -0.2443     1.0019   -0.24  0.80743    
X_tildeart                  0.7067     0.9858    0.72  0.47365    
X_tildebaby                -0.9090     1.0073   -0.90  0.36707    
X_tildepersonal_care       -1.1645     0.9598   -1.21  0.22533    
X_tildetoys                 1.2214     0.9722    1.26  0.20928    
X_tildeclothing            -0.0405     0.7201   -0.06  0.95517    
X_tildedecor                0.6599     0.9482    0.70  0.48663    
X_tildecell_phones         -0.1243     0.5666   -0.22  0.82637    
X_tildeconstruction         0.2585     0.9667    0.27  0.78921    
X_tildehome_appliances      0.3960     1.0720    0.37  0.71192    
X_tildeelectronics         -0.2746     0.6926   -0.40  0.69184    
X_tildesports              -0.1140     0.9825   -0.12  0.90769    
X_tildetools               -0.9351     1.0366   -0.90  0.36723    
X_tildegames               -0.4941     0.6857   -0.72  0.47133    
X_tildeindustry             0.8194     1.0548    0.78  0.43744    
X_tildepc                   1.1932     0.7115    1.68  0.09384 .  
X_tildejewel                0.8425     0.9792    0.86  0.38978    
X_tildebooks               -0.3454     0.9799   -0.35  0.72454    
X_tildemusic_books_movies   0.9734     0.9791    0.99  0.32035    
X_tildehealth               0.4330     0.7162    0.60  0.54560    
X_tildeintercept           52.0186     6.3475    8.20  7.8e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 15 on 974 degrees of freedom
Multiple R-squared:  0.26,  Adjusted R-squared:  0.24 
F-statistic: 13.1 on 26 and 974 DF,  p-value: &lt;2e-16</code></pre>
</div>
</div>
<p>Having trained the model, you obtain coefficients which you can multiply with <span class="math inline">\(\mathbf{X}\)</span> (not <span class="math inline">\(\mathbf{\tilde{X}}\)</span>) to get the <span class="math inline">\(CATE\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Matrix multiplication in R is done using <code>mn %*% nm</code>. Make sure to use the correct order.</p>
</div>
</div>
<p><span class="math display">\[
\hat{\tau}_{\text{RL}}(\mathbf{x}) = \mathbf{\hat{\beta}_{RL} x} \neq \mathbf{\hat{\beta}_{RL} \tilde{x}}
\]</span> <!-- Why cant I use : predict(r_learner_mod, newdata = as.data.frame(X_raw)) ??? because I did not use data =  in lm. --></p>
<p><strong>Q4: Get the predicted conditional average treatment effects CATE.</strong></p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Multiply covariates with coefficient vector</span></span>
<span><span class="va">rl_pl_CATE</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">rl_pl</span><span class="op">$</span><span class="va">coefficients</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">rl_pl_CATE</span>, breaks <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_6_files/figure-html/unnamed-chunk-6-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="week_6_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="generic-ml-r-learner" class="level4"><h4 class="anchored" data-anchor-id="generic-ml-r-learner">Generic ML R-learner</h4>
<p>In the previous estimation, we imposed linearity on the CATE. However, sometimes you might not want to assume linearity. By rearranging the minimization problem, you can see that you can use any machine learning method capable of handling weighted minimization.</p>
<p>$$ <span class="math display">\[\begin{align*}
\hat{\tau}_{\text{RL}}(\mathbf{x}) &amp;= \arg \min_{\tau} \sum_{i=1}^n ( Y_i - \hat{\mu}(\mathbf{X_i}) - \tau(\mathbf{X_i}) ( T_i - \hat{e}(\mathbf{X_i})))^2 \\

&amp;= ... \\
&amp;= \arg \min_{\tau} \sum_{i=1}^n (T_i - \hat{e}(\mathbf{X_i}))^2 \bigg(\frac{Y_i - \hat{\mu}(\mathbf{X_i})}{ T_i - \hat{e}(\mathbf{X_i})} - \tau(\mathbf{X_i})\bigg)^2 \\
\end{align*}\]</span> $$</p>
<p>The estimation procedure again requires the outcome and treatment model estimated as a first step to obtain residuals. Then, however, you proceed with the</p>
<ol type="1">
<li>weights</li>
</ol>
<p><span class="math display">\[
(T_i - \hat{e}(\mathbf{X_i}))^2,
\]</span></p>
<ol start="2" type="1">
<li>a pseudo-outcome</li>
</ol>
<p><span class="math display">\[\frac{Y_i - \hat{\mu}(\mathbf{X_i})}{ T_i - \hat{e}(\mathbf{X_i})}\]</span> and 3. unmodified covariates <span class="math inline">\(X\)</span>.</p>
<p><strong>Q5: Construct the weights and the pseudo-outcome.</strong></p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Pseudo - outcome</span></span>
<span><span class="va">Y_pseudo_rl</span> <span class="op">&lt;-</span> <span class="va">Y_res</span> <span class="op">/</span> <span class="va">D_res</span></span>
<span></span>
<span><span class="co"># Weight</span></span>
<span><span class="va">weight_rl</span> <span class="op">&lt;-</span> <span class="va">D_res</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span><span class="co"># Add pseudo-outcome, weights and unmodified covariates to a matrix/data frame</span></span>
<span><span class="va">data_rl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y_pseudo_rl</span>, <span class="va">weight_rl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Hints:</strong> ML methods capable of performing weighted minimization are e.g.&nbsp;<code>lrn("regr.xgboost")</code> or <code>lrn("regr.randomForest")</code>. To specify the weight, you can use: <code>task_rl$set_col_roles(col = "weight_rl", roles = "weight")</code>.</p>
</div>
</div>
<p><strong>Q6: Specify a ML method capable of performing weighted minimization. Then, train and predict.</strong></p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Specify task and learner</span></span>
<span><span class="co"># Task</span></span>
<span><span class="va">task_rl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_regr.html">as_task_regr</a></span><span class="op">(</span><span class="va">data_rl</span>, target <span class="op">=</span> <span class="st">"Y_pseudo_rl"</span><span class="op">)</span></span>
<span><span class="co"># Assign weight column</span></span>
<span><span class="va">task_rl</span><span class="op">$</span><span class="fu">set_col_roles</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"weight_rl"</span>, roles <span class="op">=</span> <span class="st">"weight"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify learner</span></span>
<span><span class="va">lrnr_rl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.xgboost"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train</span></span>
<span><span class="va">lrnr_rl</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_rl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predict CATEs</span></span>
<span><span class="va">rl_ml_CATE</span> <span class="op">&lt;-</span> <span class="va">lrnr_rl</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task_rl</span><span class="op">)</span><span class="op">$</span><span class="va">response</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">rl_ml_CATE</span>, breaks <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_6_files/figure-html/unnamed-chunk-8-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="week_6_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
</section></section><section id="dr-learner" class="level3"><h3 class="anchored" data-anchor-id="dr-learner">DR-learner</h3>
<p>The doubly robust learner we discussed in the previous chapter is also a metalearner we can exploit to estimate heterogeneous effects.</p>
<p><span class="math display">\[
\tau_{\text{DR}}(\mathbf{x}) = \mathbb{E}\bigg[ \underbrace{\hat{\mu}(1, \mathbf{X_i}) - \hat{\mu}(0, \mathbf{X_i}) + \frac{T_i(Y_i - \hat{\mu}(1, \mathbf{X_i}))}{ \hat{e}_1(\mathbf{X_i})} - \frac{(1-T_i)(Y_i - \hat{\mu}(0, \mathbf{X_i})}{\hat{e}_0(\mathbf{X_i}))}}_{\tilde{\tau_i}_{\text{ATE}}^{\text{AIPW}}} \bigg| \mathbf{X_i= x} \bigg]
\]</span></p>
<p>You might remember that we predicted both potential outcomes and obtained estimates of the individual treatment effect.</p>
<p><span class="math display">\[
\tau_{\text{DR}}(\mathbf{x}) = \mathbb{E}\bigg[ \tilde{\tau_i}_{\text{ATE}}^{\text{AIPW}} \bigg| \mathbf{X_i= x} \bigg]
\]</span></p>
<p>The only step left is then to regress these estimates on the assumed drivers of heterogeneity in effects.</p>
<p><span class="math display">\[
\hat{\tau}_{RL}(\mathbf{x}) = \underset{\tau}{\operatorname{arg\,min}} \sum_{i=1}^N \left( \tilde{\tau_i}_{\text{ATE}}^{\text{AIPW}} - \tau(\mathbf{X_i})\right)^2
\]</span></p>
<p><strong>Q7: Specify your nuisance parameters. Then, train and predict to obtain <code>m0_hat</code>, <code>m1_hat</code> and <code>e_hat</code>.</strong></p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Train outcome models</span></span>
<span><span class="co"># Y0 ~ X</span></span>
<span><span class="va">lrnr_m</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_m</span>, row_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">membership</span><span class="op">$</span><span class="va">card</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m0_hat</span> <span class="op">&lt;-</span> <span class="va">lrnr_m</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task_m</span><span class="op">)</span><span class="op">$</span><span class="va">response</span></span>
<span></span>
<span><span class="co"># Y1 ~ X</span></span>
<span><span class="va">lrnr_m</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task_m</span>, row_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">membership</span><span class="op">$</span><span class="va">card</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m1_hat</span> <span class="op">&lt;-</span> <span class="va">lrnr_m</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task_m</span><span class="op">)</span><span class="op">$</span><span class="va">response</span></span>
<span></span>
<span><span class="co"># D ~ X (already trained)</span></span>
<span><span class="va">e_hat</span> <span class="op">&lt;-</span> <span class="va">e_pred_tbl</span><span class="op">$</span><span class="va">prob</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Q8: Construct the pseudo-outcome used to compute the ATE <span class="math inline">\({\text{ATE}}^{\text{AIPW}}\)</span>. Regress it on <span class="math inline">\(X\)</span> and obtain the fitted values.</strong></p>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Pseudo-outcome</span></span>
<span><span class="va">tau_dr</span> <span class="op">&lt;-</span> <span class="va">m1_hat</span> <span class="op">-</span> <span class="va">m0_hat</span> <span class="op">+</span> <span class="va">D</span> <span class="op">*</span> <span class="op">(</span><span class="va">Y</span> <span class="op">-</span> <span class="va">m1_hat</span><span class="op">)</span> <span class="op">/</span> <span class="va">e_hat</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">D</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">Y</span> <span class="op">-</span> <span class="va">m0_hat</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">e_hat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit regression</span></span>
<span><span class="va">drl_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">tau_dr</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">X</span><span class="op">)</span></span>
<span><span class="co"># "Predict"</span></span>
<span><span class="va">drl_CATE</span> <span class="op">&lt;-</span> <span class="va">drl_mod</span><span class="op">$</span><span class="va">fitted.values</span></span>
<span></span>
<span><span class="co"># Plot histogram</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">drl_CATE</span>, breaks <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_6_files/figure-html/unnamed-chunk-10-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="week_6_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
</section><section id="comparison" class="level3"><h3 class="anchored" data-anchor-id="comparison">Comparison</h3>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Store and plot predictions</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  <span class="st">"R-learner (partially linear)"</span> <span class="op">=</span> <span class="va">rl_pl_CATE</span>,</span>
<span>  <span class="st">"R-learner (ML)"</span> <span class="op">=</span> <span class="va">rl_ml_CATE</span>,</span>
<span>  <span class="st">"DR-learner"</span> <span class="op">=</span> <span class="va">drl_CATE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Correlation of CATEs by different methods</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">results</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                             R-learner (partially linear) R-learner (ML) DR-learner
R-learner (partially linear)                          1.0            0.8        1.0
R-learner (ML)                                        0.8            1.0        0.8
DR-learner                                            1.0            0.8        1.0</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Summary statistics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> R-learner (partially linear).V1 R-learner (ML)    DR-learner 
 Min.   :-57                     Min.   :-12.2   Min.   :-57  
 1st Qu.: -5                     1st Qu.: -2.0   1st Qu.: -5  
 Median :  8                     Median :  1.9   Median :  8  
 Mean   :  7                     Mean   :  2.3   Mean   :  7  
 3rd Qu.: 20                     3rd Qu.:  5.7   3rd Qu.: 20  
 Max.   : 45                     Max.   : 12.4   Max.   : 46  </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Reshape data to long format</span></span>
<span><span class="va">results_long</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"Method"</span>, values_to <span class="op">=</span> <span class="st">"Value"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Method</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"R-learner (partially linear)"</span>, <span class="st">"R-learner (ML)"</span>, <span class="st">"DR-learner"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the histograms</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">results_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Adjust binwidth as needed</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Method</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Histograms of CATE Estimates by Method"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"CATE"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Frequency"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_6_files/figure-html/unnamed-chunk-14-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="week_6_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
</section></section><section id="evaluation-of-effect-heterogeneity" class="level2"><h2 class="anchored" data-anchor-id="evaluation-of-effect-heterogeneity">Evaluation of effect heterogeneity</h2>
<p>While we have learned to estimate the CATE and observe variation in the estimated individual response to the treatment, we have not yet determined whether this heterogeneity is systematic or merely noise. Evaluating our estimated CATEs is challenging because we cannot use the typical out-of-sample approach due to the missing counterfactual. Additionally, using ML methods in the final step provides no statistical inference.</p>
<p>To address this, we can derive summary statistics for the distribution of CATEs and jointly test for the presence of heterogeneity and our ability to detect it. Three methods we will explore are:</p>
<ul>
<li>
<strong>BLP:</strong> Best Linear Predictor</li>
<li>
<strong>GATES:</strong> High-vs-low Sorted Group Average Treatment Effect</li>
<li>
<strong>CLAN:</strong> Classification Analysis</li>
</ul>
<p>For the further analysis, we will rely on the <code>GenericML</code> package, which provides the functions <code><a href="https://rdrr.io/pkg/GenericML/man/get_BLP.html">get_BLP()</a></code>, <code><a href="https://rdrr.io/pkg/GenericML/man/get_GATES.html">get_GATES()</a></code> and <code>getCLAN()</code> which we can apply on a <code>GenericML</code> object.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"GenericML"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mwelz/GenericML/">GenericML</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It also builds upon the <code>mlr3</code> package and we can again specify our learners. Here, we can also specify more than one learner and let <code>GenericML</code> figure out which one performs best.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Specify set of learners</span></span>
<span><span class="va">lrnr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mlr3::lrn('svm')"</span>, <span class="st">'mlr3::lrn("ranger", num.trees = 100)'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ADD good explanation</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Specify covariates to use</span></span>
<span><span class="va">X1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GenericML/man/setup_X1.html">setup_X1</a></span><span class="op">(</span>funs_Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"B"</span>, <span class="st">"p"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You might get a warning saying that some of your propensity scores are outside the interval [0.35, 0.65]. Generally, it is only recommended to use the package when having randomized data. For the sake of demonstration, we will ignore the warning here.</p>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gen_ML</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GenericML/man/GenericML.html">GenericML</a></span><span class="op">(</span></span>
<span>  <span class="co"># data</span></span>
<span>  Z <span class="op">=</span> <span class="va">X</span>, </span>
<span>  D <span class="op">=</span> <span class="va">D</span>,</span>
<span>  Y <span class="op">=</span> <span class="va">Y</span>,</span>
<span>  <span class="co"># learners</span></span>
<span>  learners_GenericML <span class="op">=</span> <span class="va">lrnr</span>,</span>
<span>  learner_propensity_score <span class="op">=</span> <span class="st">"lasso"</span>,</span>
<span>  <span class="co"># algorithm</span></span>
<span>  num_splits <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  quantile_cutoffs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>  <span class="co"># regression setup</span></span>
<span>  X1_BLP <span class="op">=</span> <span class="va">X1</span>,</span>
<span>  X1_GATES <span class="op">=</span> <span class="va">X1</span>,</span>
<span>  <span class="co"># computational issues</span></span>
<span>  parallel <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  num_cores <span class="op">=</span> <span class="fl">6</span>, </span>
<span>  seed <span class="op">=</span> <span class="fl">11</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="best-linear-predictor" class="level3"><h3 class="anchored" data-anchor-id="best-linear-predictor">Best linear predictor</h3>
<p>First, we take a look at the best linear predictor (BLP). It aims to provide the solution of the hypothetical regression of the true CATE on the demeaned predicted CATE. Thereby, it attempts to answer whether heterogeneity is present and we are able to detect it. It is a straightforward way to check the quality of our predictions.</p>
<p><span class="math display">\[
\mathbb{E}[\tau(\mathbf{X_i}) | \hat{\tau}(\mathbf{X_i}) ] := \beta_1 + \beta_2\underbrace{(\hat{\tau}(\mathbf{X_i}) - \mathbb{E}[\hat{\tau}(\mathbf{X_i})])}_{\text{demeaned prediction}}
\]</span> Because we do not know the actual true treatment effect, we use a pseudo-response that we regress on the demeaned CATE.</p>
<p>Using <code>GenericML</code>, we just have to run:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/GenericML/man/get_BLP.html">get_BLP</a></span><span class="op">(</span><span class="va">gen_ML</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BLP generic targets
---
       Estimate CI lower CI upper p value
beta.1    6.383    3.560    9.206       0
beta.2    1.180    0.938    1.423       0
---
Confidence level of confidence interval [CI lower, CI upper]: 90 %</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_6_files/figure-html/unnamed-chunk-20-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="week_6_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
<p><strong>Question: What does <span class="math inline">\(\beta_1\)</span> represent?</strong></p>
<p><strong>Question: What does <span class="math inline">\(\beta_2\)</span> represent? What, if <span class="math inline">\(\beta_2 = 0\)</span>?</strong></p>
</section><section id="sorted-group-average-treatment-effects" class="level3"><h3 class="anchored" data-anchor-id="sorted-group-average-treatment-effects">Sorted group average treatment effects</h3>
<p>Sorted group average treatment effects (GATES) offers insights into the distribution and heterogeneity of treatment effects. The procedure involves sorting and slicing the distribution of the predicted treatment effects <span class="math inline">\(\hat{\tau}(\mathbf{X_i})\)</span> into <span class="math inline">\(K\)</span> parts and then compute <span class="math inline">\(ATE\)</span>s for each of the slices. When these slices are different from each other, we can identify subgroups which response differently to the treatment.</p>
<p>Mathematically, we ran</p>
<p><span class="math display">\[
\gamma_k := \mathbb{E}[ \tau(\mathbf{X_i}) | G_k].
\]</span></p>
<p>When the estimator approximates well, we expect to see monotonicity in estimates:</p>
<p><span class="math display">\[
\gamma_1 \leq \gamma_2 \leq \ldots \leq \gamma_K
\]</span> Using <code>GenericML</code>, we just have to run:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/GenericML/man/get_GATES.html">get_GATES</a></span><span class="op">(</span><span class="va">gen_ML</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GATES generic targets
---
                Estimate CI lower CI upper p value
gamma.1          -14.179  -21.268   -7.208    0.00
gamma.2            1.759   -4.916    8.786    0.55
gamma.3            5.966   -0.635   12.567    0.04
gamma.4           15.179    8.566   21.791    0.00
gamma.5           22.919   16.526   29.377    0.00
gamma.5-gamma.1   37.383   27.915   46.900    0.00
---
Confidence level of confidence interval [CI lower, CI upper]: 90 %</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_6_files/figure-html/unnamed-chunk-21-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="week_6_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
<p><strong>Question: Discuss the output. Do you see the assumed monotonicity in the estimates?</strong></p>
</section><section id="classification-analysis" class="level3"><h3 class="anchored" data-anchor-id="classification-analysis">Classification analysis</h3>
<p>The purpose of classification analysis (CLAN) is to explore what drives the heterogeneous effects. Instead of regressing a pseudo-outcome as in GATES, covariates, which are potential drivers of heterogeneity in treatment effect are regressed upon. In other words, CLAN is a simple mean comparison of covariates in groups split by the size of their treatment effect.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/GenericML/man/get_CLAN.html">get_CLAN</a></span><span class="op">(</span><span class="va">gen_ML</span>, variable <span class="op">=</span> <span class="st">"age"</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CLAN generic targets for variable 'age' 
---
                Estimate CI lower CI upper p value
delta.1             59.6     57.8     61.4       0
delta.2             46.2     44.7     47.7       0
delta.3             39.5     38.1     40.8       0
delta.4             32.9     31.3     34.5       0
delta.5             26.5     25.3     27.7       0
delta.5-delta.1    -33.3    -35.4    -31.2       0
---
Confidence level of confidence interval [CI lower, CI upper]: 90 %</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_6_files/figure-html/unnamed-chunk-22-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="week_6_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/GenericML/man/get_CLAN.html">get_CLAN</a></span><span class="op">(</span><span class="va">gen_ML</span>, variable <span class="op">=</span> <span class="st">"sex"</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CLAN generic targets for variable 'sex' 
---
                Estimate CI lower CI upper p value
delta.1           0.4700   0.3717   0.5683    0.00
delta.2           0.4600   0.3618   0.5582    0.00
delta.3           0.4700   0.3717   0.5683    0.00
delta.4           0.5150   0.4115   0.6085    0.00
delta.5           0.5800   0.4828   0.6772    0.00
delta.5-delta.1   0.1000  -0.0386   0.2386    0.12
---
Confidence level of confidence interval [CI lower, CI upper]: 90 %</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="week_6_files/figure-html/unnamed-chunk-23-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="week_6_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:75.0%"></a></p>
</figure>
</div>
</div>
</div>
<p><strong>Question: Interpret the plots.</strong></p>
</section></section><section id="assignment" class="level2"><h2 class="anchored" data-anchor-id="assignment">Assignment</h2>
<p>Coming soon.</p>
<div class="assignment">
<p>Accept the <a href="https://classroom.github.com/a/oPhGwOmd"><strong>Week 6 - Assignment</strong></a> and follow the same steps as last week and as described in the organization chapter.</p>
<p>For the assignments you are going to use <code>music.rds</code>. Consider the following scenario: you are a data scientist at a music streaming company. Naturally, you’re keen to engage users for as long as possible and encourage them to become avid users of your streaming app. Your colleagues from the department responsible for recommendation algorithms have developed a new fancy algorithm which aims to enhance the daily number of minutes of music listening by offering particularly well tailored recommendations. Following common practice of A/B testing, you randomly assign your users into a treatment group (new algorithm) and a control group (no new algorithm). The outcome variable is <code>minutes_spent</code> and the treatment variable is <code>new_algo</code>.</p>
<ol type="1">
<li><p>As you’ve learned, in an A/B test you just need to regress the outcome on the treatment. Follow that and interpret the estimated ATE.</p></li>
<li><p>Take a look at the two formula rearrangements for the R-learner. For both approaches, construct the predicted treatment effects and coefficients and show the equivalence.</p></li>
<li><p>Using the <code>DoubleML</code> package, run the DR-learner and check for CATEs based on your available covariates. Do you find heterogeneous treatment effects? If yes, interpret them (also with regard to your coefficient in the first task). Please note that to extract the doubly robust <span class="math inline">\(\tilde{\tau_i}_{\text{ATE}}\)</span>, you need to access <code>dr_mod$psi_b</code>.</p></li>
<li><p>For the covariate <code>app_usage_frequency</code>, use the package <code>np</code> to check for non-linear heterogeneous treatment effects. Check lecture slide 12 for more details. Discuss the result.</p></li>
</ol>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../../../content/course_weeks/week_05/week_5.html" class="pagination-link  aria-label=" double="" machine="" learning="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">5 - Double Machine Learning</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../content/course_weeks/week_07/week_7.html" class="pagination-link" aria-label="7 - Unobserved Confounding &amp; Instrumental Variables">
        <span class="nav-page-text">7 - Unobserved Confounding &amp; Instrumental Variables</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>lv3095_s24: Causal Data Science for Business Analytics</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>


</body></html>